{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home2.css' %}">

<style>
  /* ===== Modal do Formulário (popup) ===== */
  .modal-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.65);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 1rem;
  }
  .modal-card{
    width: min(920px, 95vw);
    background: #1f1f1f;
    color: #fff;
    border-radius: 12px;
    box-shadow: 0 12px 36px rgba(0,0,0,.6);
    overflow: hidden;
    border: 1px solid #2a2a2a;
  }
  .modal-header{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
    padding: .75rem 1rem;
    border-bottom: 1px solid #2a2a2a;
    background: #202020;
  }
  .modal-header h3{
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #eaeaea;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .modal-actions{ display:flex; align-items:center; gap:.5rem; }
  .modal-btn{
    appearance: none;
    border: 1px solid #3a3a3a;
    background: #2b2b2b;
    color: #fff;
    padding: .4rem .7rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: .9rem;
  }
  .modal-btn:hover{ filter: brightness(1.05); }
  .modal-close{
    border: 0; background: transparent; color: #bbb;
    cursor: pointer; font-size: 1.2rem; line-height: 1; padding: .2rem .4rem;
  }
  .modal-close[disabled]{ opacity:.5; cursor:not-allowed; }
  .modal-close:hover:not([disabled]){ color: #fff; }
  .modal-body{ padding: 0; }
  .modal-iframe{
    width: 100%;
    height: 72vh; /* ajustado via postMessage também */
    border: 0;
    background: #111;
  }

  @keyframes shake { 10%, 90% {transform: translateX(-1px);} 20%, 80% {transform: translateX(2px);}
    30%, 50%, 70% {transform: translateX(-4px);} 40%, 60% {transform: translateX(4px);} }
  .shake { animation: shake .4s linear; }

  /* ===== Selo do provedor (pequenininho) ===== */
  .provider-row{display:flex;justify-content:flex-end;margin:.25rem 0 .3rem}
  .provider-chip{
    font-size:.72rem;line-height:1; color:#bdbdbd;
    border:1px solid rgba(255,255,255,.18);
    border-radius:999px; padding:.18rem .5rem; opacity:.9;
    display:inline-flex; align-items:center; gap:.35rem;
    background: rgba(255,255,255,.04);
  }
  .provider-chip svg{width:12px;height:12px;opacity:.9;display:block}
</style>
{% endblock %}

{% block content %}

  {# ===== Modal do Formulário (exibe 1 pendente) ===== #}
  {% if form_popup %}
  <div class="modal-overlay" id="form-popup-overlay">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="form-popup-title">
      <div class="modal-header">
        <h3 id="form-popup-title">{{ form_popup.titulo }}</h3>
        <div class="modal-actions">
          <button class="modal-btn" onclick="document.getElementById('form-popup-iframe')?.contentWindow?.location.reload()">Recarregar</button>
          <button class="modal-close" id="modal-close-btn" aria-label="Fechar" onclick="fecharFormPopup()" disabled title="Feche após enviar a resposta">✕</button>
        </div>
      </div>
      <div class="modal-body">
        <iframe
          id="form-popup-iframe"
          class="modal-iframe"
          src="{% url 'formularios:exibir_formulario' form_popup.pk %}?embed=1">
        </iframe>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="icon-grid-container">
    <a href="{% url 'tecnicon' %}" class="modal-content">
      <div class="modal-container">
        <img src="{% static 'images/Tecnicon.png' %}" class="modal-img" alt="">
        <span class="modal-title">Tecnicon</span>
      </div>
    </a>
    <a href="{% url 'allcance' %}" class="modal-content">
      <div class="modal-container">
        <img src="{% static 'images/Allcance.png' %}" class="modal-img" alt="">
        <span class="modal-title">Allcance</span>
      </div>
    </a>
    <a href="https://mail.google.com/mail" target="_blank" id="email-link" class="modal-content" rel="noopener">
      <div class="modal-container">
        <img src="{% static 'images/gmail.png' %}" class="modal-img" alt="">
        <span class="modal-title">Gmail</span>
      </div>
    </a>
    <a href="https://rotoview.irp.rotoplastyc.com/" target="_blank" class="modal-content" rel="noopener">
      <div class="modal-container">
        <img src="{% static 'images/Rotoview.png' %}" class="modal-img" alt="">
        <span class="modal-title">Rotoview</span>
      </div>
    </a>
    <a href="{% url 'glpi' %}" class="modal-content">
      <div class="modal-container">
        <img src="{% static 'images/GLPI.png' %}" class="modal-img" alt="">
        <span class="modal-title">GLPI</span>
      </div>
    </a>
    <a href="https://irp.rotoplastyc.com/sistemas/" target="_blank" class="modal-content" rel="noopener">
      <div class="modal-container">
        <img src="{% static 'images/Sistemas Rotoplastyc.png' %}" class="modal-img" alt="">
        <span class="modal-title">Sistemas Rotoplastyc</span>
      </div>
    </a>
    <a href="{% url 'gestao' %}" class="modal-content">
      <div class="modal-container">
        <img src="{% static 'images/GestaoPessoas.png' %}" class="modal-img" alt="">
        <span class="modal-title">Gestão de Pessoas</span>
      </div>
    </a>
    <a href="https://irp.rotoplastyc.com/agenda/" target="_blank" class="modal-content" rel="noopener">
      <div class="modal-container">
        <img src="{% static 'images/Tarifador.png' %}" class="modal-img" alt="">
        <span class="modal-title">Tarifador</span>
      </div>
    </a>
    <a href="{% url 'mural' %}" class="modal-content">
      <div class="modal-container">
        <img src="{% static 'images/Mural.png' %}" class="modal-img" alt="">
        <span class="modal-title">Mural de Sugestões</span>
      </div>
    </a>
    <a href="{% url 'ideias_protagonistas' %}" class="modal-content">
      <div class="modal-container">
        <img src="{% static 'images/pensando.png' %}" class="modal-img" alt="">
        <span class="modal-title">Ideias Protagonistas</span>
      </div>
    </a>
    <a href="{% url 'indicadores' %}" target="_blank" class="modal-content" rel="noopener">
      <div class="modal-container">
        <img src="{% static 'images/Indicadores.png' %}" class="modal-img" alt="">
        <span class="modal-title">Indicadores</span>
      </div>
    </a>
    <a href="https://sig.grupoadvis.com.br/login" target="_blank" class="modal-content" rel="noopener">
      <div class="modal-container">
        <img src="{% static 'images/SIG.png' %}" class="modal-img" alt="">
        <span class="modal-title">SIG</span>
      </div>
    </a>
    <a href="{% url 'manuais' %}" class="modal-content">
      <div class="modal-container">
        <img src="{% static 'images/Manuais.png' %}" class="modal-img" alt="">
        <span class="modal-title">Manuais</span>
      </div>
    </a>
    <a href="http://plmpro:3000/" class="modal-content">
      <div class="modal-container">
        <img src="{% static 'images/teamcenter.png' %}" class="modal-img" alt="">
        <span class="modal-title">Teamcenter</span>
      </div>
    </a>
  </div>

  <!-- ===================== Weather (modern) ===================== -->
  <div class="weather-card" role="region" aria-label="Previsão do tempo">
    {% if provider %}
      <div class="provider-row">
        <span class="provider-chip" title="{{ api_tooltip }}">
          {% if provider == 'openmeteo' %}
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 19a5 5 0 0 1 0-10 6 6 0 0 1 11.31-1.99A4.5 4.5 0 1 1 18 19H6z"/></svg>
            Dados: Open-Meteo
          {% elif provider == 'climatempo' %}
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm0-14V2m0 20v-2M4.22 4.22 5.64 5.64M18.36 18.36l1.42 1.42M2 12h2m16 0h2M4.22 19.78 5.64 18.36M18.36 5.64l1.42-1.42"/></svg>
            Dados: Climatempo
          {% endif %}
        </span>
      </div>
    {% endif %}

    {% if erro %}

    {% else %}

      {% if clima_atual %}
      <header class="wx-header">
        <div class="wx-title">
          <span>Tempo agora</span>
        </div>
        <div class="wx-updated" title="Última atualização">
          <svg class="wx-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M13 3a9 9 0 1 0 8.94 10.06h-2.02A7 7 0 1 1 13 5v2l4-3-4-3v2Z"/></svg>
          <span>{{ clima_atual.data }}</span>
        </div>
      </header>

      <section class="wx-now">
        {% if clima_atual.icone %}
          <img class="wx-big-ico" src="{% static 'images/' %}{{ clima_atual.icone }}.png" alt="" aria-hidden="true">
        {% endif %}

        <div class="wx-temp" aria-label="Temperatura atual">
          <span class="wx-temp-value">{{ clima_atual.temperatura_atual|floatformat:0 }}</span><span class="wx-temp-unit">°C</span>
        </div>

        <div class="wx-cond">{{ clima_atual.condicao }}</div>

        <div class="wx-chips" role="list">
          <div class="wx-chip" role="listitem">
            <span class="wx-chip-label">Sensação</span>
            <strong class="wx-chip-value">{{ clima_atual.sensacao|floatformat:0 }}°C</strong>
          </div>
          <div class="wx-chip" role="listitem">
            <span class="wx-chip-label">Umidade</span>
            <strong class="wx-chip-value">{{ clima_atual.humidade|floatformat:0 }}%</strong>
          </div>
        </div>

        {% if clima_stale %}
          <div class="wx-badge wx-badge-warn" title="Mostrando do cache/LKG">offline / cache</div>
        {% endif %}
      </section>
      {% else %}
        <div class="wx-empty"><p>Dados do clima atual não disponíveis.</p></div>
      {% endif %}

      <hr class="wx-sep"/>

      {% if previsao %}
      <section class="wx-forecast" aria-label="Previsão do dia selecionado">
        <div class="wx-forecast-head">
          <h3>Previsão do dia</h3>
          {% if previsao_stale %}
            <span class="wx-note">usando última previsão (LKG)</span>
          {% endif %}
        </div>

        <div class="wx-forecast-main">
          <button class="wx-nav prev" aria-label="Dia anterior" onclick="mudarDia({{ dia_atual|add:'-1' }})">&#8249;</button>

          <div id="previsao-dia" class="wx-day">
            <div class="wx-date">{{ previsao.data_br }}</div>

            {% if previsao.condicao_icone %}
              <img class="wx-mid-ico" src="{% static 'images/' %}{{ previsao.condicao_icone }}.png" alt="" aria-hidden="true">
            {% endif %}

            <div class="wx-range" aria-label="Temperatura do dia">
              <span class="wx-max">{{ previsao.temperatura_max|floatformat:0 }}°C</span>
              <span class="wx-min">min {{ previsao.temperatura_min|floatformat:0 }}°C</span>
            </div>

            <div class="wx-rain" aria-label="Probabilidade de chuva">
              <div class="wx-rain-label">
                <img src="{% static 'images/rain-icon.png' %}" alt="" class="rain-icon" aria-hidden="true">
                {{ previsao.probabilidade_chuva }}%
              </div>
            </div>

            <div class="wx-cond-small">{{ previsao.condicao }}</div>
          </div>

          <button class="wx-nav next" aria-label="Próximo dia" onclick="mudarDia({{ dia_atual|add:'1' }})">&#8250;</button>
        </div>
      </section>
      {% else %}
        <div class="wx-empty"><p>Dados de previsão não disponíveis.</p></div>
      {% endif %}

    {% endif %}
  </div>
  <!-- ===================== /Weather ===================== -->

  <script>
    let canCloseForm = false;

    function mudarDia(dia) {
      const queryString = new URLSearchParams(window.location.search);
      queryString.set('dia', String(dia));
      window.location.search = queryString.toString();
    }

    function fecharFormPopup(){
      if(!canCloseForm){
        const btn = document.getElementById('modal-close-btn');
        if(btn){ btn.classList.add('shake'); setTimeout(()=>btn.classList.remove('shake'), 400); }
        return;
      }
      const el = document.getElementById('form-popup-overlay');
      if(el) el.remove();
    }

    // Ajusta altura do iframe e libera Fechar quando enviado
    window.addEventListener('message', (e)=>{
      if(e && e.data){
        if(e.data.type === 'formHeight'){
          const ifr = document.getElementById('form-popup-iframe');
          if(ifr){
            const maxH = Math.floor(window.innerHeight * 0.9);
            ifr.style.height = Math.min(e.data.h, maxH) + 'px';
          }
        }
        if(e.data.type === 'formSubmitted'){
          canCloseForm = true;
          const btn = document.getElementById('modal-close-btn');
          if(btn){
            btn.disabled = false;
            btn.title = 'Fechar';
          }
          setTimeout(()=>fecharFormPopup(), 900);
        }
      }
    });

    // Navegação por setas do teclado
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft')  { mudarDia({{ dia_atual|add:'-1' }}); }
      if (e.key === 'ArrowRight') { mudarDia({{ dia_atual|add:'1' }}); }
    });
  </script>
{% endblock %}

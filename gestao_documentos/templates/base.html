{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Portal Rotoplastyc{% endblock %}</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Menu Superior -->
    <header class="top-bar">
        <div class="menu-icon" onclick="toggleMenu()">
            <span class="icon">&#9776;</span>
        </div>

        <!-- Notificações e Perfil agrupados -->
        <div class="top-bar-right">
            <!-- Notificações -->
            <div class="notification-bell">
                <a href="#" onclick="toggleNotificationDropdown()" class="notification-link">
                    <img src="{% static 'images/notificacao.png' %}" alt="Notificações" class="bell-icon">
                    {% if notificacoes_nao_lidas|length > 0 %}
                        <span class="notification-count" id="notification-count">{{ notificacoes_nao_lidas|length }}</span>
                    {% endif %}
                </a>
                <div id="notification-dropdown" class="notification-dropdown">
                    <ul id="notification-list">
                        {% for notificacao in notificacoes_nao_lidas %}
                            <li id="notification-{{ notificacao.id }}">
                                <div class="notification-message">
                                    <!-- Exibindo a foto do solicitante -->
                                    <img src="{% if notificacao.solicitante.profile_photo and notificacao.solicitante.profile_photo.url != '' %}{{ notificacao.solicitante.profile_photo.url }}{% else %}{% static 'images/default_user.png' %}{% endif %}" alt="Foto do Solicitante" class="user-avatar">
                                    <p>{{ notificacao.mensagem }}</p>
                                    <div class="notification-controls">
                                        <a href="{% url 'documentos:listar_aprovacoes_pendentes' %}" class="notification-action">Ir para aprovações</a>
                                    </div>
                                </div>
                                <button class="close-notification" data-id="{{ notificacao.id }}">✖</button>
                            </li>
                        {% empty %}
                            <li>Nenhuma notificação pendente.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Menu de perfil -->
            <div class="profile-dropdown">
                <div class="profile-icon" onclick="toggleProfileMenu()">
                    <img src="{% if user.profile_photo and user.profile_photo.url != '' %}{{ user.profile_photo.url }}{% else %}{% static 'images/default_user.png' %}{% endif %}" alt="Usuário" class="profile-photo">
                    <span class="dropdown">&#9660;</span>
                </div>
                <div id="profile-menu" class="profile-menu">
                    <div class="profile-info">
                        <p>Minha Conta ({{ user.username }})</p>
                        <p>{{ user.email }}</p>
                    </div>
                    <ul>
                        <li><a href="{% url 'usuarios:perfil_usuario' %}">Perfil do Usuário</a></li>
                        <li><a href="{% url 'logout' %}">Sair</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- Menu Lateral -->
    <nav class="side-bar" id="side-bar">
        <ul>
            <li>
                <a href="{% url 'home' %}">
                    <img src="{% static 'images/home-icon.png' %}" alt="Home">
                    <span class="menu-label">Home</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="toggleSubmenu(event, this)">
                    <img src="{% static 'images/documento.png' %}" alt="Documentos">
                    <span class="menu-label">Documentos</span>
                </a>
                <ul class="submenu">
                    <li><a href="{% url 'documentos:listar_documentos_aprovados' %}">Listar Documentos</a></li>
                    <li><a href="{% url 'documentos:listar_aprovacoes_pendentes' %}">Aprovações Pendentes</a></li>
                    <li><a href="{% url 'documentos:listar_documentos_reprovados' %}">Reprovações</a></li>
                    <li><a href="{% url 'documentos:listar_categorias' %}">Categorias</a></li>
                </ul>
            </li>
            <li>
                <a href="#" onclick="toggleSubmenu(event, this)">
                    <img src="{% static 'images/administracao.png' %}" alt="Administração">
                    <span class="menu-label">Administração</span>
                </a>
                <ul class="submenu">
                    <li><a href="{% url 'usuarios:lista_usuarios' %}">Usuários</a></li>
                    <li><a href="{% url 'usuarios:lista_grupos' %}">Grupos de Usuários</a></li>
                    <li><a href="{% url 'usuarios:liberar_permissoes' %}">Permissões</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <!-- Conteúdo da página -->
    <div class="main-content">
        {% block content %}
        {% endblock %}
    </div>

    <!-- Scripts globais -->
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        function toggleMenu() {
            var sideBar = document.getElementById("side-bar");
            sideBar.classList.toggle("expanded");

            if (!sideBar.classList.contains("expanded")) {
                var submenus = document.querySelectorAll('.submenu');
                submenus.forEach(function(submenu) {
                    submenu.classList.remove('open');
                });
            }
        }

        function toggleNotificationDropdown() {
            var notificationDropdown = document.getElementById("notification-dropdown");
            notificationDropdown.classList.toggle("open");
        }

        function toggleProfileMenu() {
            var profileMenu = document.getElementById("profile-menu");
            profileMenu.classList.toggle("open");
        }

        function toggleSubmenu(event, element) {
            event.preventDefault();

            if (document.getElementById("side-bar").classList.contains("expanded")) {
                var submenu = element.nextElementSibling;
                submenu.classList.toggle('open');
                var allSubmenus = document.querySelectorAll('.submenu');
                allSubmenus.forEach(function(s) {
                    if (s !== submenu) {
                        s.classList.remove('open');
                    }
                });
            }
        }

        document.addEventListener('click', function(event) {
            var profileMenu = document.getElementById("profile-menu");
            var notificationDropdown = document.getElementById("notification-dropdown");

            if (!profileMenu.contains(event.target) && !event.target.closest('.profile-icon')) {
                profileMenu.classList.remove('open');
            }

            if (!notificationDropdown.contains(event.target) && !event.target.closest('.notification-bell')) {
                notificationDropdown.classList.remove('open');
            }
        });

        // Atualiza o contador de notificações na bolinha
        function updateNotificationCount() {
            const notificationCountElement = document.getElementById('notification-count');
            let currentCount = parseInt(notificationCountElement.textContent);
            currentCount = currentCount - 1;
            if (currentCount > 0) {
                notificationCountElement.textContent = currentCount;
            } else {
                notificationCountElement.style.display = 'none';
            }
        }

        // Enviar a requisição para marcar a notificação como lida
        document.querySelectorAll('.close-notification').forEach(function(button) {
            button.addEventListener('click', function() {
                var notificacaoId = this.getAttribute('data-id');
                console.log('Clicado para fechar notificação com ID:', notificacaoId);

                fetch(`/notificacoes/marcar-notificacao-como-lida/${notificacaoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        console.log('Notificação marcada como lida.');
                        this.closest('li').style.display = 'none';
                        updateNotificationCount();  // Atualizar o contador
                    } else {
                        console.error('Erro ao marcar a notificação como lida.');
                    }
                })
                .catch(error => console.error('Erro:', error));
            });
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>

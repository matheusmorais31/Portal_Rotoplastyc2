<!-- bi/visualizar_bi.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/visualizar_bi.css' %}">

{% endblock %}

{% block content %}

  <!-- Barra de ferramentas -->
  <div class="bi-toolbar" role="toolbar" aria-label="Barra de ferramentas do relat√≥rio">
    <div class="title">{{ bi_report.title }}</div>
    <div class="spacer"></div>

    <!-- Badge de √∫ltima atualiza√ß√£o (EPOCH + ISO) -->
    <div class="last-upd" id="lastUpd"
         data-last-epoch="{{ bi_report.last_updated|date:'U'|default:'' }}"
         data-next-epoch="{{ bi_report.next_update|date:'U'|default:'' }}"
         data-last-iso="{{ bi_report.last_updated|date:'c'|default:'' }}"
         data-next-iso="{{ bi_report.next_update|date:'c'|default:'' }}"
         title="√öltima atualiza√ß√£o do dataset no Power BI">
      <span class="dot" aria-hidden="true"></span>
      <span id="lastUpdText">Atualiza√ß√£o: ‚Äî</span>
    </div>

    <!-- Dropdown de vis√µes -->
    <div class="views-dropdown" id="viewsDropdown">
      <button class="btn" id="btnViews" aria-haspopup="true" aria-expanded="false">Vis√µes ‚ñæ</button>

      <!-- Come√ßa aqui, mas ser√° portalizada para o <body> -->
      <div class="views-menu" id="menuViews" role="menu" aria-label="Vis√µes salvas" style="display:none;">
        <div class="header">
          <input type="text" id="viewsSearch" placeholder="Filtrar por nome‚Ä¶">
          <span class="helpent">‚èé aplica</span>
        </div>
        <div class="views-list" id="viewsList"><!-- linhas via JS --></div>
        <div style="padding:.25rem .35rem 0 .35rem; display:flex; gap:.4rem; justify-content:flex-end;">
          <button class="btn" id="btnReloadViews" title="Recarregar vis√µes">Recarregar</button>
        </div>
      </div>
    </div>

    <button class="btn" id="btnSaveView">Salvar vis√£o</button>

    <!-- Dropdown ‚ÄúExibi√ß√£o‚Äù -->
    <div class="dropdown" id="viewDropdown">
      <button class="btn" id="btnView" aria-haspopup="true" aria-expanded="false">Exibi√ß√£o ‚ñæ</button>
      <div class="menu" id="menuView" role="menu" aria-label="Exibi√ß√£o" style="display:none;">
        <button class="btndrop" data-view="fitToPage"  role="menuitem">üß© Ajustar √† p√°gina</button>
        <button class="btndrop" data-view="fitToWidth" role="menuitem">‚ÜîÔ∏è Ajustar √† largura</button>
        <button class="btndrop" data-view="actualSize" role="menuitem">1:1 Tamanho real</button>
      </div>
    </div>

    <button class="btn" id="btnFull">Tela inteira</button>

    <!-- Bot√£o Atualizar com spinner (inicia oculto; ser√° exibido se N√ÉO houver refresh em andamento) -->
    <button class="btnrefresh" id="btnRefreshNow" aria-live="polite" aria-busy="false" title="Aciona atualiza√ß√£o do dataset e dataflows upstream (cascata)" style="display:none">
      <span class="spinner" aria-hidden="true"></span>
      <span class="label">Atualizar agora</span>
    </button>

    <!-- Pill: status de refresh em andamento (Power BI Web manual/agendado ou via bot√£o local) -->
    <span id="refreshInProg" class="refresh-pill" style="display:none"
          title="H√° uma atualiza√ß√£o em andamento no Power BI">
      <span class="dot" aria-hidden="true"></span>
      <span id="refreshInProgText">Atualiza√ß√£o em andamento‚Ä¶</span>
    </span>

    <button class="btn btn-danger" id="btnReset">Redefinir filtros</button>
  </div>

  <div id="reportContainer">
    <div id="bootMask" class="boot-mask" aria-live="polite">
      <div class="box">
        Aplicando seus filtros‚Ä¶ <span id="bootStep">iniciando</span>
      </div>
    </div>
  </div>

  <!-- Modal: Salvar/Editar vis√£o -->
  <div class="modal" id="saveViewModal" aria-hidden="true" role="dialog" aria-label="Salvar/Editar vis√£o">
    <div class="modal-card">
      <div class="modal-header">
        <div id="modalTitle" style="font-weight:700">Salvar & compartilhar vis√£o</div>
        <button class="btnclose" id="btnCloseSaveModal">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="form-row inline">
          <div class="form-row">
            <label for="svName">Nome</label>
            <input type="text" id="svName" maxlength="140" placeholder="Ex.: Vendas ‚Äì Regi√£o Sul (YTD)">
          </div>
          <div class="form-row">
            <label for="svVisibility">Visibilidade</label>
            <select id="svVisibility">
              <option value="private">Privada (s√≥ eu)</option>
              <option value="public">P√∫blica (todos que veem o BI)</option>
              <option value="users">Usu√°rios espec√≠ficos</option>
              <option value="groups">Grupos espec√≠ficos</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <label for="svDesc">Descri√ß√£o (opcional)</label>
          <textarea id="svDesc" placeholder="Ajude os outros a entender o objetivo desta vis√£o‚Ä¶"></textarea>
        </div>

        <!-- Usu√°rios espec√≠ficos (auto-complete) -->
        <div class="form-row" id="rowUsers" style="display:none">
          <label for="svUsersSearch">Compartilhar com usu√°rios</label>
          <input type="text" id="svUsersSearch" placeholder="Digite o nome, usu√°rio ou e-mail">
          <div id="svUsersSelected" class="help"></div>
          <div id="usersSuggestBox" class="suggest"></div>
        </div>

        <!-- Grupos -->
        <div class="form-row" id="rowGroups" style="display:none">
          <label for="svGroups">Grupos (busca din√¢mica)</label>
          <input type="text" id="svGroups" placeholder="Digite e pressione Enter">
          <div id="svGroupsSelected" class="help"></div>
        </div>

        <div class="help">
          A vis√£o guarda filtros, p√°gina ativa e sele√ß√µes de slicers. Use <span class="kbd">Vis√µes ‚ñæ</span> para aplicar depois.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btncancel" id="btnSaveViewCancel">Cancelar</button>
        <button class="btnsave" id="btnSaveViewSubmit">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.23.0/dist/powerbi.min.js"></script>
  <script>
    (() => {
      const models        = window['powerbi-client'].models;
      const reportId      = '{{ bi_report.report_id }}';
      const groupId       = '{{ bi_report.group_id }}';
      const serverState   = {{ initial_state_json|safe }} || {};
      const serverStateUpdatedAt = '{{ initial_state_updated_at|default:"" }}';
      const REFRESH_MS    = 50 * 60 * 1000; // 50 min
      const TRACE_ID      = '{{ trace_id }}';
      const USER_ID       = '{{ request.user.id }}';

      // URLs backend
      const URL_SAVE_STATE   = '{% url "bi:salvar_estado_relatorio" %}';
      const URL_EMBED_PARAMS = '{% url "bi:get_embed_params" %}';
      const URL_LAST_RT      = '{% url "bi:get_last_update_rt" %}';
      const URL_REFRESH_NOW  = '{% url "bi:refresh_now" %}';
      const URL_REFRESH_ST   = '{% url "bi:get_refresh_status" %}';

      const URL_VIEWS_LIST   = '{% url "bi:saved_views_list" %}';
      const URL_VIEWS_SAVE   = '{% url "bi:saved_views_save" %}';
      const URL_VIEWS_GET    = '{% url "bi:saved_views_get" %}';
      const URL_VIEWS_DEL    = '{% url "bi:saved_views_delete" %}';
      const URL_USER_SEARCH  = '{% url "bi:buscar_usuarios" %}';
      const URL_GROUP_SEARCH = '{% url "bi:buscar_grupos" %}';

      const LS_VER  = '{{ bi_report.last_updated|date:"U"|default:"0" }}';
      const LS_KEY       = `pbiState:${USER_ID}:${groupId}:${reportId}:v${LS_VER}`;
      const BASE_BM_PREFIX = `pbiBase:${groupId}:${reportId}:v${LS_VER}`;
      const BASE_BM_KEY    = `${BASE_BM_PREFIX}:__global`;
      const norm = (s) => (typeof s === 'string' ? s.trim() : '');
      const pageBaseKey    = (pageName) => `${BASE_BM_PREFIX}:pg:${norm(pageName)}`;

      let report;
      let readyToCapture = false;
      let tokenRefreshTimer = null;

      let pendingBookmarkState = null;
      let firstRenderDone = false;
      let SKIP_STATE_RESTORE_ONCE = false;

      // ========= Utils UI =========
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      function toast(msg, ms=2600){ const t=$('#toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); }
      function getCookie(name) {
        const v = `; ${document.cookie}`;
        const parts = v.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
      }

      // ========= LOG / MASK =========
      function log(level, msg, obj) {
        const t = performance.now().toFixed(1);
        const tag = `[PBI:${level}] (${TRACE_ID}) ${t}ms ${msg}`;
        if (obj !== undefined) (console[level] || console.log).call(console, tag, obj);
        else (console[level] || console.log).call(console, tag);
      }
      const bootMask = document.getElementById('bootMask');
      const bootStepEl = document.getElementById('bootStep');
      const setBootStep = (t) => { if (bootStepEl) bootStepEl.textContent = t; };
      const hideBootMask = () => { if (bootMask) bootMask.style.display = 'none'; };
      const showBootMask = () => { if (bootMask) bootMask.style.display = ''; };

      function summarize(state) {
        try {
          const rf = Array.isArray(state?.reportFilters) ? state.reportFilters.length : 0;
          const ap = state?.activePage || null;
          const slicerPages = state?.slicers && typeof state.slicers === 'object' ? Object.keys(state.slicers).length : 0;
          const slicerVisuals = slicerPages ? Object.values(state.slicers).reduce((a, v) => a + (v && typeof v === 'object' ? Object.keys(v).length : 0), 0) : 0;
          const hasBm = typeof state?.bookmarkState === 'string' && state.bookmarkState.length > 0;
          const bmLen = hasBm ? state.bookmarkState.length : 0;
          return { rf, ap, slicerPages, slicerVisuals, hasBm, bmLen, keys: Object.keys(state || {}) };
        } catch { return { rf: 0, ap: null, slicerPages: 0, slicerVisuals: 0, hasBm: false, bmLen: 0, keys: [] }; }
      }
      function loadLocalState() {
        try {
          const s = localStorage.getItem(LS_KEY);
          const parsed = s ? JSON.parse(s) : {};
          if (parsed && parsed._uid && parsed._uid !== USER_ID) {
            log('info','loadLocalState skip: uid mismatch', { saved: parsed._uid, current: USER_ID });
            return {};
          }
          log('debug', 'loadLocalState()', { summary: summarize(parsed), raw: parsed });
          return parsed || {};
        } catch (e) {
          log('warn', 'loadLocalState parse error', e);
          return {};
        }
      }
      function saveLocalState(state, updatedAtMs) {
        try {
          if (!readyToCapture) { log('debug', 'saveLocalState skipped (not readyToCapture)'); return; }
          const copy = JSON.parse(JSON.stringify(state || {}));
          copy._uid = USER_ID;
          copy._updatedAt = typeof updatedAtMs === 'number' ? updatedAtMs : Date.now();
          localStorage.setItem(LS_KEY, JSON.stringify(copy));
          log('debug', 'saveLocalState()', { summary: summarize(copy) });
        } catch (e) {
          log('warn', 'saveLocalState error', e);
        }
      }
      function debounce(fn, delay=900) {
        let t=null;
        return (...args) => {
          clearTimeout(t);
          if (!readyToCapture && fn === captureState) return;
          t = setTimeout(() => fn.apply(this, args), delay);
        };
      }
      async function snapshotCurrentState(){
        const snap = {};
        try { if (report?.getFilters) snap.reportFilters = await report.getFilters(); } catch(e){ log('debug','snapshot:getFilters fail', e); }
        try {
          if (report?.getActivePage){
            const pg = await report.getActivePage();
            if (pg) snap.activePage = pg.displayName || pg.name;
          }
        } catch(e){ log('debug','snapshot:getActivePage fail', e); }
        try {
          if (report?.bookmarksManager?.capture) {
            const bm = await report.bookmarksManager.capture();
            if (bm?.state) snap.bookmarkState = bm.state;
          }
        } catch(e){ log('debug','snapshot:bookmark fail', e); }
        log('info','snapshotCurrentState ‚Üí', summarize(snap));
        return snap;
      }

      async function applyStateObject(pick, { preRender = false } = {}){
        const bm  = (typeof pick?.bookmarkState === 'string' && pick.bookmarkState.length) ? pick.bookmarkState : null;
        const flt = Array.isArray(pick?.reportFilters) ? pick.reportFilters : [];
        const the_ap  = pick?.activePage || null;

        if (preRender && bm) {
          pendingBookmarkState = bm;
        }

        if (flt.length && report?.setFilters) {
          try { await report.setFilters(flt); } catch(e){ log('debug','setFilters preRender fail', e); }
        }
        if (the_ap) {
          try {
            const pages = await report.getPages();
            const toGo = pages.find(p => p.displayName === the_ap || p.name === the_ap);
            if (toGo) await toGo.setActive();
          } catch(e){ log('debug','setActive preRender fail', e); }
        }

        if (!preRender && bm && report?.bookmarksManager?.applyState) {
          await report.bookmarksManager.applyState(bm);
        }
      }

      async function captureState() {
        const t0 = performance.now();
        try {
          const currentState = await snapshotCurrentState();
          saveLocalState(currentState);
          const res = await fetch(URL_SAVE_STATE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ report_id: reportId, group_id: groupId, state: currentState })
          });
          const txt = await res.text();
          log('info', `save_state (normal) ‚Üí ${res.status}`, txt);
          try {
            const j = JSON.parse(txt || '{}');
            if (j?.ok && j.updated_at) saveLocalState(currentState, Date.parse(j.updated_at));
          } catch {}
        } catch (err) {
          log('error', 'captureState error', err);
        } finally {
          log('debug', `captureState took ${(performance.now() - t0).toFixed(1)}ms`);
        }
      }
      const saveStateDebounced = debounce(captureState, 900);

      const VALID_EMBED_URL = /^https:\/\/app\.powerbi\.(com|us|gov|cn)\/reportEmbed(\?|$)/i;
      function normalizeEmbedUrl(u){
        if (!u || typeof u !== 'string') return '';
        return u.replace(/&amp;/g,'&').replace(/\s+/g,'').trim();
      }
      function ensureValidEmbedUrl(u){
        const s = normalizeEmbedUrl(u);
        return VALID_EMBED_URL.test(s) ? s : '';
      }
      function buildEmbedUrl(reportId, groupId){
        return `https://app.powerbi.com/reportEmbed?reportId=${encodeURIComponent(reportId)}&groupId=${encodeURIComponent(groupId)}`;
      }

      const INITIAL_URL   = ensureValidEmbedUrl('{{ embed_url|escapejs }}') || buildEmbedUrl(reportId, groupId);
      const INITIAL_TOKEN = '{{ embed_token|escapejs }}';

      async function fetchEmbedParams(){
        const res  = await fetch(URL_EMBED_PARAMS, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify({ report_id: reportId, group_id: groupId })
        });
        const text = await res.text();
        if (!res.ok) throw new Error(`get_embed_params HTTP ${res.status}`);
        let data = {};
        try { data = JSON.parse(text || '{}'); } catch {}

        const candidate = data.embed_url || data.embedUrl || data.embedURL || data.url || '';
        const url  = ensureValidEmbedUrl(candidate) || buildEmbedUrl(reportId, groupId);
        const token = (data.embed_token || INITIAL_TOKEN || '').trim();

        log('info','fetchEmbedParams resolved', { usingUrl: url.slice(0,100)+'‚Ä¶' });
        return { url, token };
      }

      async function captureBaseForActivePageIfMissing(){
        try{
          if (!report?.bookmarksManager?.capture) return;
          const ap = await report.getActivePage();
          if (!ap) return;
          const key = pageBaseKey(ap.name || ap.displayName || '');
          if (!key) return;
          if (!localStorage.getItem(key)){
            const base = await report.bookmarksManager.capture();
            if (base?.state){
              localStorage.setItem(key, base.state);
              if (!localStorage.getItem(BASE_BM_KEY)) localStorage.setItem(BASE_BM_KEY, base.state);
              log('info','base bookmark capturado p/ p√°gina', { page: norm(ap.displayName || ap.name) });
            }
          }
        }catch(e){ log('debug','captureBaseForActivePageIfMissing fail', e); }
      }

      function hardClearContainer(){
        const container = document.getElementById('reportContainer');
        if (!container) return;
        try { window.powerbi.reset(container); } catch {}
        Array.from(container.querySelectorAll('iframe')).forEach(n => n.remove());
      }
      function waitTwoFrames(){
        return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
      }

      async function embedReportPhased(embedUrl, accessToken) {
        const url = ensureValidEmbedUrl(embedUrl) || buildEmbedUrl(reportId, groupId);
        const token = (accessToken || INITIAL_TOKEN || '').trim();

        const container = document.getElementById('reportContainer');
        if (!container) throw new Error('reportContainer n√£o encontrado');

        hardClearContainer();
        await waitTwoFrames();

        const config = {
          type: 'report',
          id:   reportId,
          embedUrl:    url,
          accessToken: token,
          tokenType:   models.TokenType.Embed,
          permissions: models.Permissions.View,
          phasedEmbedding: true,
          filters: [],
          settings: {
            panes: { filters: { visible: true }, pageNavigation: { visible: true } },
            navContentPaneEnabled: true,
            layoutType:  models.LayoutType.Custom,
            customLayout:{ displayOption: models.DisplayOption.FitToPage },
            persistentFiltersEnabled: false
          }
        };

        if (!ensureValidEmbedUrl(config.embedUrl)) {
          throw new Error('Embed URL inv√°lida ap√≥s normaliza√ß√£o');
        }

        // (n√£o repetir reset aqui; j√° fizemos em hardClearContainer)
        const rpt = window.powerbi.embed(container, config);
        report = rpt;

        // üëá d√° tempo do iframe inicializar o canal postMessage antes do load()
        await waitTwoFrames();

        rpt.off && rpt.off('loaded');
        rpt.off && rpt.off('rendered');
        rpt.off && rpt.off('filtersApplied');
        rpt.off && rpt.off('pageChanged');
        rpt.off && rpt.off('dataSelected');

        rpt.on('rendered', async () => {
          log('info','event: rendered (phased)');
          try {
            if (!firstRenderDone) {
              if (pendingBookmarkState && report?.bookmarksManager?.applyState){
                try{
                  setBootStep('aplicando vis√£o salva‚Ä¶');
                  await report.bookmarksManager.applyState(pendingBookmarkState);
                  pendingBookmarkState = null;
                  try { await report.refresh(); } catch(e){ log('debug','refresh p√≥s-bookmark fail', e); }
                }catch(e){ log('debug','apply bookmark p√≥s-render falhou', e); }
              }

              try {
                await captureBaseForActivePageIfMissing();
                if (!localStorage.getItem(BASE_BM_KEY) && report?.bookmarksManager?.capture){
                  const base = await report.bookmarksManager.capture();
                  if (base?.state) {
                    localStorage.setItem(BASE_BM_KEY, base.state);
                    log('info','baseline global capturado');
                  }
                }
              } catch (e) {
                log('debug','baseline p√≥s-render falhou', e);
              }

              firstRenderDone = true;
              SKIP_STATE_RESTORE_ONCE = false;
              readyToCapture = true;
              hideBootMask();
              captureState();
              refreshLastUpdBadgeRt();
              await loadSavedViews();
            } else {
              if (readyToCapture) saveStateDebounced();
            }
          } catch (e) {
            log('error','rendered handler fail', e);
          }
        });

        rpt.on('filtersApplied', () => { if (!readyToCapture) return; saveStateDebounced(); });
        rpt.on('pageChanged',  async () => {
          if (!readyToCapture) return;
          await captureBaseForActivePageIfMissing();
          saveStateDebounced();
        });
        rpt.on('dataSelected', () => { if (!readyToCapture) return; saveStateDebounced(); });

        try {
          await rpt.load();
          log('info','report.load() OK');

          if (!SKIP_STATE_RESTORE_ONCE) {
            const local = loadLocalState();
            const serverRich = JSON.parse(JSON.stringify(serverState || {}));
            if (serverStateUpdatedAt) serverRich._updatedAt = Date.parse(serverStateUpdatedAt);

            const pick = (function better(a,b){
              const sa = summarize(a), sb = summarize(b);
              if (sa.hasBm !== sb.hasBm) return sb.hasBm ? b : a;
              if (sa.hasBm && sb.hasBm && sa.bmLen !== sb.bmLen) return sb.bmLen > sa.bmLen ? b : a;
              if (sb.slicerVisuals !== sa.slicerVisuals) return sb.slicerVisuals > sa.slicerVisuals ? b : a;
              if (sb.rf !== sa.rf) return sb.rf > sa.rf ? b : a;
              const aTs = typeof a?._updatedAt === 'number' ? a._updatedAt : 0;
              const bTs = typeof b?._updatedAt === 'number' ? b._updatedAt : 0;
              return (bTs - aTs) > 10000 ? b : a;
            })(local, serverRich);

            setBootStep('aplicando seus filtros‚Ä¶');
            await applyStateObject(pick, { preRender: true });
          } else {
            log('info','skip restore (hard reset)');
          }

          setBootStep('renderizando‚Ä¶');
          await rpt.render();
        } catch (e) {
          log('error','load/render fail', e);
        }
      }

      async function refreshAccessTokenLoop(){
        try{
          if(!report) return;
          const { token } = await fetchEmbedParams();
          if (report.setAccessToken) {
            await report.setAccessToken(token);
            log('info','access token refreshed');
          }
        }catch(e){ log('debug','refreshAccessTokenLoop fail', e); }
      }

      let TZ_ID = 'America/Sao_Paulo';
      function fmtBr(dt){
        try { return new Intl.DateTimeFormat('pt-BR',{dateStyle:'short', timeStyle:'short', timeZone:TZ_ID}).format(dt); }
        catch { return dt.toLocaleString('pt-BR'); }
      }
      function timeAgo(fromDate){
        const s = Math.max(0, Math.floor((Date.now()-fromDate.getTime())/1000));
        if (s < 60) return `h√° ${s}s`;
        const m = Math.floor(s/60);
        if (m < 60) return `h√° ${m} min`;
        const h = Math.floor(m/60);
        if (h < 24) return `h√° ${h} h`;
        const d = Math.floor(h/24);
        return `h√° ${d} d`;
      }
      function getDateFromAttrs(prefix){
        const wrap = document.getElementById('lastUpd');
        if (!wrap) return null;
        const raw = wrap.getAttribute(`data-${prefix}-epoch`);
        const hasEpoch = raw !== null && raw !== '' && !Number.isNaN(Number(raw));
        const epoch = hasEpoch ? Number(raw) : 0;
        if (epoch > 0) return new Date(epoch * 1000);
        const iso = wrap.getAttribute(`data-${prefix}-iso`) || '';
        if (iso) { const d = new Date(iso); if (!isNaN(d.getTime())) return d; }
        return null;
      }
      function updateLastUpdBadge(){
        const wrap  = document.getElementById('lastUpd');
        const label = document.getElementById('lastUpdText');
        if (!wrap || !label) return;

        const dt  = getDateFromAttrs('last');
        const ndt = getDateFromAttrs('next');

        if (!dt){
          wrap.classList.remove('ok','warn','stale');
          wrap.classList.add('unknown');
          label.textContent = 'Atualiza√ß√£o: ‚Äî';
          wrap.title = 'Sem informa√ß√£o de atualiza√ß√£o do dataset';
          return;
        }

        const ageHours = (Date.now() - dt.getTime())/36e5;

        wrap.classList.remove('unknown','ok','warn','stale');
        if (ageHours <= 3) wrap.classList.add('ok');
        else if (ageHours <= 24) wrap.classList.add('warn');
        else wrap.classList.add('stale');

        const base = `Atualiza√ß√£o: ${fmtBr(dt)} (${timeAgo(dt)})`;
        wrap.title = ndt
          ? `√öltima atualiza√ß√£o do dataset no Power BI: ${fmtBr(dt)}\nPr√≥xima prevista: ${fmtBr(ndt)} (${TZ_ID})`
          : `√öltima atualiza√ß√£o do dataset no Power BI: ${fmtBr(dt)} (${TZ_ID})`;
        label.textContent = base;
      }

      async function refreshLastUpdBadgeRt(){
        const wrap = document.getElementById('lastUpd');
        if (!wrap) return;

        try{
          const res = await fetch(URL_LAST_RT, {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Accept':'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ report_id: '{{ bi_report.report_id }}', group_id:  '{{ bi_report.group_id }}' }),
            cache: 'no-store', credentials: 'same-origin',
          });
          const txt = await res.text();
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = JSON.parse(txt || '{}');

          if (data && data.ok){
            if (data.tz && typeof data.tz === 'string') TZ_ID = data.tz;
            wrap.setAttribute('data-last-epoch', data.last_updated_epoch ?? '');
            wrap.setAttribute('data-next-epoch', data.next_update_epoch ?? '');
            wrap.setAttribute('data-last-iso',   data.last_updated_iso   ?? '');
            wrap.setAttribute('data-next-iso',   data.next_update_iso    ?? '');
          }
        }catch(err){
          console.warn('[PBI:lastUpdateRT:fail]', err);
        }finally{
          updateLastUpdBadge();
          // üî• reprograma a sonda conforme o "next_update" atualizado e dispara checagem imediata
          scheduleAdaptiveProbe();
          probeRefreshStart();
        }
      }

      function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
      function getBadgeLastEpoch(){
        const wrap = document.getElementById('lastUpd');
        if (!wrap) return 0;
        const raw = wrap.getAttribute('data-last-epoch');
        const n = Number(raw || 0);
        return Number.isFinite(n) ? n : 0;
      }
      // ‚ûï pega o "pr√≥ximo update" para janelar a sonda
      function getNextEpoch(){
        const wrap = document.getElementById('lastUpd');
        if (!wrap) return 0;
        const raw = wrap.getAttribute('data-next-epoch');
        const n = Number(raw || 0);
        return Number.isFinite(n) ? n : 0;
      }

      function setBtnLoading(btn, isLoading, textLoading = 'Atualizando‚Ä¶', textIdle = 'Atualizar agora'){
        if (!btn) return;
        const lbl = btn.querySelector('.label');
        if (isLoading){
          btn.classList.add('loading'); btn.disabled = true; btn.setAttribute('aria-busy','true');
          if (lbl) lbl.textContent = textLoading;
        } else {
          btn.classList.remove('loading'); btn.disabled = false; btn.setAttribute('aria-busy','false');
          if (lbl) lbl.textContent = textIdle;
        }
      }

      async function getRefreshStatus(afterEpoch){
        const res = await fetch(URL_REFRESH_ST, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify({ report_id: reportId, group_id: groupId, after_epoch: afterEpoch || null }),
          cache: 'no-store', credentials: 'same-origin'
        });
        const txt = await res.text();
        if (!res.ok) throw new Error(`get_refresh_status HTTP ${res.status}`);
        const data = JSON.parse(txt || '{}');
        return data;
      }

      // --- NORMALIZA√á√ÉO DE STATUS (robusto a formatos diferentes) ---
      function _lc(v){ return (v==null ? '' : String(v)).toLowerCase().trim(); }

      // Decide apenas o "canal" do refresh ‚Üí "via api" | "via PowerBI Web"
      function inferChannelTag(obj, rawType){
        const bag = [
          rawType, obj.refresh_type, obj.type, obj.refreshType,
          obj.trigger_source, obj.triggerSource,
          obj.initiated_by, obj.initiatedBy,
          obj.requested_by, obj.requestedBy,
          obj.source, obj.via, obj.method, obj.origin
        ].map(x => String(x || '')).join('|').toLowerCase();

        if (/(api|enhancedapi|xmla|rest|sdk|powershell)/.test(bag)) return 'via api';
        if (/(scheduled|agendado)/.test(bag)) return 'via PowerBI Web';
        if (/(manual|on[-\s]?demand|ui|web)/.test(bag)) return 'via PowerBI Web';
        return 'via PowerBI Web';
      }

      function normalizeOneRefresh(obj){
        const rawStatus = _lc(obj.status ?? obj.state ?? obj.refresh_status ?? obj.stage);
        const rawType   = _lc(obj.refresh_type ?? obj.type ?? obj.refreshType);
        const inProgFlags = new Set(['inprogress','running','notstarted','pending','queued']);

        const bools =
          (obj.in_progress ?? obj.inProgress ?? obj.is_running ?? obj.running ?? false) ? true : false;

        const hasStart = Number.isFinite(obj.start_epoch) || obj.startTime || obj.startDateTime;
        const hasEnd   = Number.isFinite(obj.end_epoch)   || obj.endTime   || obj.endDateTime;

        const inProgress = bools || inProgFlags.has(rawStatus) || (hasStart && !hasEnd);

        const failed = new Set(['failed','cancelled','canceled','disabled','error']).has(rawStatus);

        const origin = inferChannelTag(obj, rawType); // üëà s√≥ "via api" | "via PowerBI Web"

        const errMsg = obj.error_message ?? obj.errorMessage ?? obj.message ?? '';
        const errCode= obj.error_code ?? obj.errorCode ?? '';

        return {
          inProgress, failed, origin, rawStatus, rawType,
          errMsg: (typeof errMsg === 'string' ? errMsg : ''),
          errCode: (typeof errCode === 'string' ? errCode : ''),
          start_epoch: obj.start_epoch, end_epoch: obj.end_epoch
        };
      }

      function pickStatusFromResponse(resp){
        const list = Array.isArray(resp)            ? resp
                   : Array.isArray(resp?.items)     ? resp.items
                   : Array.isArray(resp?.refreshes) ? resp.refreshes
                   : resp?.item ? [resp.item]
                   : [resp];

        const normalized = list.map(normalizeOneRefresh);

        // Se qualquer falhou ‚Üí prioriza falha
        const anyFailed = normalized.find(x => x.failed);
        if (anyFailed) return { inProgress:false, failed:true, origin:anyFailed.origin, error:anyFailed.errMsg, code:anyFailed.errCode, debug:normalized };

        // Se qualquer em progresso ‚Üí est√° em andamento
        const anyRunning = normalized.find(x => x.inProgress);
        if (anyRunning) return { inProgress:true, failed:false, origin:anyRunning.origin, debug:normalized };

        // Nenhum em progresso e ningu√©m falhou ‚Üí parado
        return { inProgress:false, failed:false, origin:'via PowerBI Web', debug:normalized };
      }

      // ===== Helpers para bot√£o/pill (mostrar/esconder) =====
      function showRefreshBtn(show=true){
        const btn = document.getElementById('btnRefreshNow');
        if (!btn) return;
        btn.style.display = show ? '' : 'none';
      }
      function syncRefreshControls(inProgress, label){
        if (inProgress){
          setRefreshPill(true, `Atualiza√ß√£o em andamento‚Ä¶ (${label || 'via PowerBI Web'})`);
          showRefreshBtn(false);
        } else {
          setRefreshPill(false);
          showRefreshBtn(true);
        }
      }

      // ===== Pill de refresh (sonda + polling) =====
      const pillEl = document.getElementById('refreshInProg');
      const pillTextEl = document.getElementById('refreshInProgText');
      function setRefreshPill(on, text){
        if(!pillEl) return;
        pillEl.style.display = on ? 'inline-flex' : 'none';
        if (on && text && pillTextEl) pillTextEl.textContent = text;
      }
      let refreshPollTimer = null;
      let refreshProbeTimer = null;

      function stopRefreshPolling(){
        if (refreshPollTimer){ clearInterval(refreshPollTimer); refreshPollTimer = null; }
        // terminou (ou falhou) ‚Üí esconder pill e voltar bot√£o
        syncRefreshControls(false);
      }

      async function startRefreshPolling(kindLabel='via PowerBI Web'){
        if (refreshPollTimer){
          // j√° est√° polling ‚Äî s√≥ atualiza r√≥tulo/visuais
          syncRefreshControls(true, kindLabel);
          return;
        }
        syncRefreshControls(true, kindLabel);
        const TICK_MS = 10000; // 10s
        refreshPollTimer = setInterval(async () => {
          try{
            const st = await getRefreshStatus();
            const picked = pickStatusFromResponse(st);
            console.debug('[refreshPolling] parsed ->', picked.debug);

            if (picked.failed){
              stopRefreshPolling();
              const err = (picked.error || '').trim();
              if (err) alert(`Falha na atualiza√ß√£o:\n\n${err}`);
              else alert('Falha na atualiza√ß√£o do dataset (Power BI).');
              return;
            }

            if (!picked.inProgress){
              stopRefreshPolling();
              await refreshLastUpdBadgeRt();
              try { await report.refresh(); } catch(e) {}
              toast('Dados atualizados.');
            } else {
              syncRefreshControls(true, picked.origin); // üëà usa s√≥ ‚Äúvia ‚Ä¶‚Äù
            }
          }catch(e){
            console.warn('[refreshPolling] erro', e);
          }
        }, TICK_MS);
      }

      async function probeRefreshStart(){
        try{
          const st = await getRefreshStatus();
          const picked = pickStatusFromResponse(st);
          console.debug('[probeRefreshStart] parsed ->', picked.debug);

          if (picked.failed){
            // Falhou ‚Äî n√£o fica em progresso; mostra bot√£o (e pode avisar silenciosamente)
            stopRefreshPolling();
            return;
          }

          if (picked.inProgress){
            startRefreshPolling(picked.origin); // üëà usa s√≥ ‚Äúvia ‚Ä¶‚Äù
          } else {
            // N√£o h√° refresh em andamento ‚Üí garantir que o bot√£o esteja vis√≠vel
            stopRefreshPolling();
          }
        }catch(e){
          // silencioso; manter estado atual
          console.debug('[probeRefreshStart] erro', e);
        }
      }

      // üîÅ Sonda adaptativa: acelera perto do pr√≥ximo agendamento
      function scheduleAdaptiveProbe(){
        if (refreshProbeTimer){ clearInterval(refreshProbeTimer); refreshProbeTimer = null; }
        const nextEpoch = getNextEpoch();
        const nowSec    = Math.floor(Date.now()/1000);
        const dist      = nextEpoch ? Math.abs(nextEpoch - nowSec) : 999999;
        const HOT_WINDOW_S = 10 * 60; // ¬±10 min

        const intervalMs = dist <= HOT_WINDOW_S ? 5 * 1000   // 5s na janela quente
                          : 25 * 1000;                       // 25s fora dela

        refreshProbeTimer = setInterval(probeRefreshStart, intervalMs);
      }

      async function forceRefreshNow(){
        const btn = document.getElementById('btnRefreshNow');
        if (!btn) return;
        try{
          // liga pill imediatamente e oculta bot√£o
          startRefreshPolling('via api'); // üëà bot√£o da tela = via api

          setBtnLoading(btn, true);
          showBootMask(); setBootStep('for√ßando atualiza√ß√£o do dataset‚Ä¶');

          const beforeEpoch = getBadgeLastEpoch();

          const res = await fetch(URL_REFRESH_NOW, {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({
              report_id: reportId,
              group_id: groupId,
              cascade: true,
              wait_for_dataflows: true,
              fail_on_dataflow_error: true,
              df_timeout_s: 3600,
              poll_every_s: 20,
              refresh_type: 'Full'
            }),
            cache: 'no-store', credentials: 'same-origin'
          });
          const txt = await res.text();
          log('info', `refresh_now ‚Üí ${res.status}`, txt);

          if (res.status === 429){
            try{
              const j = JSON.parse(txt||'{}');
              alert(`Uma atualiza√ß√£o acabou de ser solicitada. Tente novamente em ~${j.retry_seconds || 60}s.`);
            }catch{ alert('Aguarde um pouco antes de tentar novamente.'); }
            return;
          }
          if (!res.ok){
            alert('Falha ao acionar a atualiza√ß√£o do dataset. Verifique credenciais/gateway.');
            return;
          }

          const triggerEpoch = Math.floor(Date.now() / 1000);
          setBootStep('aguardando conclus√£o do refresh‚Ä¶');
          const deadlineMs = Date.now() + (15 * 60 * 1000);
          let changed = false, failed = false, failMsg = '';

          while (Date.now() < deadlineMs){
            await sleep(10_000);
            await refreshLastUpdBadgeRt();
            const nowEpoch = getBadgeLastEpoch();
            if (nowEpoch && nowEpoch > beforeEpoch){ changed = true; break; }

            try{
              const st = await getRefreshStatus(triggerEpoch);
              const picked = pickStatusFromResponse(st);

              if (picked.failed){
                failed  = true;
                failMsg = picked.error || 'O servi√ßo reportou falha no refresh.';
                break;
              }

              // prote√ß√£o: muito tempo ‚Äúem progresso‚Äù
              if (picked.inProgress){
                const tooLong = (Date.now() - (triggerEpoch*1000)) > (20*60*1000);
                if (tooLong){
                  failed  = true;
                  failMsg = 'O refresh est√° em execu√ß√£o h√° muito tempo e pode estar travado (timeout).';
                  break;
                }
              }
            }catch(e){ console.warn('[refreshStatus] falha tempor√°ria', e); }
          }

          if (changed){
            setBootStep('aplicando dados novos‚Ä¶');
            try { await report.refresh(); log('info','report.refresh() OK'); }
            catch(e){ log('warn','report.refresh() falhou', e); }
            updateLastUpdBadge();
            setBootStep('dados atualizados ‚úî');
          } else if (failed){
            setBootStep('falha no refresh');
            const human = (failMsg || '').trim() || 'Falha ao atualizar o dataset no Power BI.';
            alert(`N√£o foi poss√≠vel concluir o refresh:\n\n${human}`);
          } else {
            setBootStep('refresh n√£o confirmou no tempo limite');
            alert('O servi√ßo n√£o confirmou a atualiza√ß√£o dentro do tempo limite. Verifique o hist√≥rico do dataset no Power BI.');
          }
        }catch(err){
          log('error', 'forceRefreshNow fail', err);
          alert('Erro ao acionar atualiza√ß√£o.');
        }finally{
          await sleep(600);
          hideBootMask();
          setBtnLoading(document.getElementById('btnRefreshNow'), false);
          // N√ÉO mostramos o bot√£o aqui: quem decide √© o polling (stopRefreshPolling ao concluir)
        }
      }

      async function clearSlicersOnPage(page){
        try{
          const visuals = await page.getVisuals();
          for (const v of visuals){
            const t = (v.type || '').toLowerCase();
            if (t === 'slicer' && v.getSlicerState && v.setSlicerState){
              try{
                const st = await v.getSlicerState();
                const newSt = { ...st, filters: [] };
                await v.setSlicerState(newSt);
              }catch(e){
                log('debug','clear slicer fail', { name: v.name, e });
              }
            }
          }
        }catch(e){ log('debug','getVisuals fail', e); }
      }
      async function clearCurrentPage(){
        try{
          try { await report.setFilters([]); } catch(e){ log('debug','report.setFilters([]) fail', e); }

          const ap = await report.getActivePage();
          if (ap){
            try { await ap.setFilters([]); } catch(e){ log('debug','page.setFilters([]) fail', e); }
            await clearSlicersOnPage(ap);
          }
        }catch(e){ log('debug','clearCurrentPage fail', e); }
      }

      let _resetInFlight = false;
      async function resetAll(){
        if (_resetInFlight) return;
        _resetInFlight = true;
        const btn = document.getElementById('btnReset');
        if (btn) btn.disabled = true;

        try{
          showBootMask(); setBootStep('redefinindo para publicado‚Ä¶');
          readyToCapture = false;

          localStorage.removeItem(LS_KEY);
          try{
            await fetch(URL_SAVE_STATE, {
              method:'POST',
              headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCookie('csrftoken') },
              body: JSON.stringify({ report_id: reportId, group_id: groupId, state: {} })
            });
          }catch{}

          SKIP_STATE_RESTORE_ONCE = true;
          firstRenderDone = false;
          pendingBookmarkState = null;

          let params;
          try {
            params = await fetchEmbedParams();
            await embedReportPhased(params.url, params.token);
          } catch (e1) {
            log('warn','resetAll 1¬™ tentativa falhou ‚Äì retry curto', e1);
            await new Promise(r => setTimeout(r, 400));
            params = await fetchEmbedParams();
            await embedReportPhased(params.url, params.token);
          }
        }catch(e){
          log('error','resetAll fail', e);
          alert('N√£o foi poss√≠vel redefinir os filtros agora. Tente novamente.');
        }finally{
          hideBootMask();
          _resetInFlight = false;
          if (btn) btn.disabled = false;
        }
      }

      // ========= VIS√ïES SALVAS ‚Äì UI/Fluxo =========
      const btnViews = $('#btnViews');
      const menuViews = $('#menuViews');
      const viewsListEl = $('#viewsList');
      const viewsSearch = $('#viewsSearch');
      const btnReloadViews = $('#btnReloadViews');
      const btnSaveView = $('#btnSaveView');

      let cachedViews = []; // [{...}]
      let viewsScrim = null; // overlay para fechar fora

      function renderViewsList(filter=''){
        const q = (filter || '').toLowerCase();
        viewsListEl.innerHTML = '';
        const items = cachedViews.filter(v => v.name.toLowerCase().includes(q));
        if (!items.length){
          const empty = document.createElement('div');
          empty.className = 'view-row';
          empty.innerHTML = '<div class="view-title">Nenhuma vis√£o encontrada.</div>';
          viewsListEl.appendChild(empty);
          return;
        }
        for (const v of items){
          const row = document.createElement('div');
          row.className = 'view-row';

          const left = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'view-title';
          title.textContent = v.name;
          title.title = v.description || '';
          title.style.cursor = 'pointer';
          title.addEventListener('click', () => { closeViewsMenu(); applySavedView(v.id); });

          const meta = document.createElement('div');
          meta.className = 'view-meta';
          const badVis = document.createElement('span');
          badVis.className = 'badge-pill ' + (v.visibility === 'public' ? 'badge-pub': v.visibility === 'private' ? 'badge-priv': '');
          badVis.textContent = v.visibility;
          meta.innerHTML = `de <strong>${v.owner_name || v.owner}</strong> ‚Ä¢ ${new Date(v.updated_at).toLocaleString('pt-BR')}`;
          meta.appendChild(badVis);
          if (v.is_default){
            const badDef = document.createElement('span');
            badDef.className = 'badge-pill badge-def';
            badDef.textContent = 'padr√£o';
            meta.appendChild(badDef);
          }
          left.appendChild(title);
          left.appendChild(meta);

          const right = document.createElement('div');
          right.className = 'view-actions';

          const bApply = document.createElement('button');
          bApply.className = 'mini';
          bApply.textContent = 'Aplicar';
          bApply.addEventListener('click', () => { closeViewsMenu(); applySavedView(v.id); });
          right.appendChild(bApply);

          if (v.token){
            const bLink = document.createElement('button');
            bLink.className = 'mini';
            bLink.textContent = 'Copiar link';
            bLink.addEventListener('click', () => { closeViewsMenu(); copyLinkForToken(v.token); });
            right.appendChild(bLink);
          }

          if (v.is_owner){
            const bEdit = document.createElement('button');
            bEdit.className = 'mini';
            bEdit.textContent = 'Editar';
            bEdit.addEventListener('click', () => { closeViewsMenu(); openEditModalById(v.id); });
            right.appendChild(bEdit);

            const bDel = document.createElement('button');
            bDel.className = 'minidel';
            bDel.textContent = 'Excluir';
            bDel.addEventListener('click', () => { closeViewsMenu(); deleteView(v.id); });
            right.appendChild(bDel);
          }

          row.appendChild(left);
          row.appendChild(right);
          viewsListEl.appendChild(row);
        }
      }

      async function loadSavedViews(){
        try{
          const url = new URL(URL_VIEWS_LIST, window.location.origin);
          url.searchParams.set('report_id', reportId);
          url.searchParams.set('group_id', groupId);
          const res = await fetch(url.toString(), { credentials:'same-origin' });
          const js  = await res.json();
          if (!res.ok || !js?.ok) throw new Error('list fail');
          cachedViews = js.views || [];
          renderViewsList(viewsSearch.value);
          log('info', 'savedViews loaded', { count: cachedViews.length });
        }catch(e){
          console.warn('loadSavedViews fail', e);
          cachedViews = [];
          renderViewsList('');
        }
      }

      async function applySavedView(id){
        showBootMask(); setBootStep('aplicando vis√£o‚Ä¶'); readyToCapture = false;
        try{
          const res = await fetch(URL_VIEWS_GET + `?id=${encodeURIComponent(id)}&report_id=${encodeURIComponent(reportId)}&group_id=${encodeURIComponent(groupId)}`, { credentials:'same-origin' });
          const js  = await res.json();
          if (!res.ok || !js?.ok) throw new Error('get fail');
          const state = js.state || (js.view && js.view.state) || {};
          await applyStateObject(state);
          try{ await report.refresh(); }catch{}
          toast('Vis√£o aplicada.');
        }catch(e){
          console.error('applySavedView fail', e);
          alert('Falha ao aplicar vis√£o.');
        }finally{
          hideBootMask();
          readyToCapture = true;
          saveStateDebounced();
        }
      }

      async function deleteView(id){
        if (!confirm('Excluir esta vis√£o?')) return;
        try{
          const res = await fetch(URL_VIEWS_DEL, {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify({ id })
          });
          const js = await res.json();
          if (!res.ok || !js?.ok) throw new Error('delete fail');
          toast('Vis√£o exclu√≠da.');
          await loadSavedViews();
        }catch(e){ console.error('deleteView fail', e); alert('Falha ao excluir vis√£o.'); }
      }

      function copyLinkForToken(token){
        const base = window.location.origin + "{{ request.path }}";
        const link = `${base}?view=${encodeURIComponent(token)}`;
        navigator.clipboard?.writeText(link).then(() => toast('Link copiado!')).catch(() => {
          prompt('Copie o link:', link);
        });
      }

      // ========= Modal (Salvar / Editar) =========
      const modal = $('#saveViewModal');
      const modalTitle = $('#modalTitle');
      const btnOpenModal = $('#btnSaveView');
      const btnCloseSaveModal = $('#btnCloseSaveModal');
      const btnSaveModalCancel = $('#btnSaveViewCancel');
      const btnSaveModalSubmit = $('#btnSaveViewSubmit');
      const svName = $('#svName');
      const svDesc = $('#svDesc');
      const svVis  = $('#svVisibility');

      const svUsersSearch   = document.getElementById('svUsersSearch');
      const svUsersSelected = document.getElementById('svUsersSelected');
      const usersSuggestBox = document.getElementById('usersSuggestBox');
      let selectedUserIds   = [];

      const rowUsers  = $('#rowUsers');
      const rowGroups = $('#rowGroups');
      const svGroups  = $('#svGroups');
      const svGroupsSelected = $('#svGroupsSelected');
      let selectedGroupIds = [];

      let isEditing = false;
      let editingViewId = null;

      function pillsFromGroupIds(ids){
        svGroupsSelected.innerHTML='';
        (ids||[]).forEach(id=>{
          const pill=document.createElement('span');
          pill.className='badge-pill removable';
          pill.textContent=`Grupo ${id}`;
          const close=document.createElement('button'); close.type='button'; close.innerHTML='√ó';
          close.addEventListener('click',()=>{ selectedGroupIds=selectedGroupIds.filter(g=>g!==id); pillsFromGroupIds(selectedGroupIds); });
          pill.appendChild(close);
          svGroupsSelected.appendChild(pill);
        });
      }

      function renderUserChips(idsWithNames){
        svUsersSelected.innerHTML = '';
        (idsWithNames || []).forEach(u => {
          const pill = document.createElement('span');
          pill.className = 'badge-pill removable';
          pill.textContent = u.name || (`Usu√°rio ${u.id}`);
          const close = document.createElement('button');
          close.type='button'; close.innerHTML='√ó';
          close.addEventListener('click', () => {
            selectedUserIds = selectedUserIds.filter(x => x !== u.id);
            renderUserChips(idsWithNames.filter(x => x.id !== u.id));
          });
          pill.appendChild(close);
          svUsersSelected.appendChild(pill);
        });
      }
      function _debounce(fn, ms=300){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

      const doUserSearch = _debounce(async (term) => {
        if(!term || term.length < 2){ usersSuggestBox.classList.remove('open'); usersSuggestBox.innerHTML=''; return; }
        try{
          const url = new URL(URL_USER_SEARCH, window.location.origin);
          url.searchParams.set('q', term);
          const r = await fetch(url.toString(), { credentials:'same-origin' });
          const list = await r.json();
          const ul = document.createElement('div'); ul.className='suggest-list';
          (list || []).forEach(item => {
            const li = document.createElement('div');
            li.className='suggest-item';
            li.textContent = `${item.name} (${item.username})`;
            li.addEventListener('click', () => {
              if(!selectedUserIds.includes(item.id)){
                selectedUserIds.push(item.id);
                renderUserChips([...(selectedUserIds.map(id => list.find(x=>x.id===id) || {id, name:`Usu√°rio ${id}`}))]);
              }
              svUsersSearch.value = '';
              usersSuggestBox.classList.remove('open');
              usersSuggestBox.innerHTML='';
            });
            ul.appendChild(li);
          });
          usersSuggestBox.innerHTML=''; usersSuggestBox.appendChild(ul);
          usersSuggestBox.classList.toggle('open', (list || []).length > 0);
        }catch{
          usersSuggestBox.classList.remove('open'); usersSuggestBox.innerHTML='';
        }
      }, 250);

      svUsersSearch?.addEventListener('input', (e)=> doUserSearch(e.target.value));
      document.addEventListener('click', (e) => {
        if (!usersSuggestBox.contains(e.target) && e.target !== svUsersSearch){
          usersSuggestBox.classList.remove('open'); usersSuggestBox.innerHTML='';
        }
      }, {passive:true});

      function openModalForCreate(){
        isEditing=false; editingViewId=null;
        modalTitle.textContent='Salvar & compartilhar vis√£o';
        btnSaveModalSubmit.textContent='Salvar';
        const now=new Date();
        svName.value=`Vis√£o ${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}`;
        svDesc.value=''; svVis.value='private';
        selectedUserIds=[]; svUsersSearch.value=''; svUsersSelected.innerHTML='';
        selectedGroupIds=[]; svGroups.value=''; pillsFromGroupIds([]);
        updateVisibilityFields();
        modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); setTimeout(()=>svName.focus(),50);
      }

      async function openEditModalById(id){
        try{
          const r=await fetch(`${URL_VIEWS_GET}?id=${encodeURIComponent(id)}&report_id=${encodeURIComponent(reportId)}&group_id=${encodeURIComponent(groupId)}`);
          const js=await r.json(); if(!r.ok||!js?.ok) throw 0;
          const v=js.view || js;
          isEditing=true; editingViewId=id;
          modalTitle.textContent='Editar vis√£o';
          btnSaveModalSubmit.textContent='Atualizar';
          svName.value=v.name||''; svDesc.value=v.description||''; svVis.value=v.visibility||'private';

          selectedUserIds = [...(v.shared_user_ids||[])];
          renderUserChips((v.shared_users||[]).map(u=>({id:u.id, name:u.name})));

          selectedGroupIds=[...(v.shared_group_ids||[])];
          svGroups.value=''; pillsFromGroupIds(selectedGroupIds);

          updateVisibilityFields();
          modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); setTimeout(()=>svName.focus(),50);
        }catch{ alert('N√£o foi poss√≠vel abrir a vis√£o para edi√ß√£o.'); }
      }

      function closeModal(){
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden','true');
      }

      function updateVisibilityFields(){
        const v = svVis.value;
        rowUsers.style.display  = v === 'users' ? '' : 'none';
        rowGroups.style.display = v === 'groups' ? '' : 'none';
      }
      svVis.addEventListener('change', updateVisibilityFields);

      svGroups.addEventListener('keydown', async (e) => {
        if (e.key !== 'Enter') return;
        e.preventDefault();
        const term = svGroups.value.trim();
        if (!term) return;
        try{
          const url = new URL(URL_GROUP_SEARCH, window.location.origin);
          url.searchParams.set('q', term);
          const r = await fetch(url.toString(), { credentials:'same-origin' });
          const js = await r.json();
          if (Array.isArray(js) && js.length){
            const g = js[0];
            if (!selectedGroupIds.includes(g.id)){
              selectedGroupIds.push(g.id);
              pillsFromGroupIds(selectedGroupIds);
            }
            svGroups.value = '';
          }else{
            alert('Nenhum grupo encontrado.');
          }
        }catch{ alert('Erro ao buscar grupos.'); }
      });

      async function submitSaveOrUpdate(){
        try{
          btnSaveModalSubmit.disabled=true;
          const payload={
            report_id:reportId,
            group_id:groupId,
            name:svName.value.trim(),
            description:svDesc.value.trim(),
            visibility:svVis.value,
            shared_user_ids:selectedUserIds,
            shared_group_ids:selectedGroupIds
          };
          if(!payload.name){ alert('Informe um nome para a vis√£o.'); return; }

          if(isEditing){
            const res=await fetch(URL_VIEWS_SAVE,{
              method:'POST',
              headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
              body:JSON.stringify({...payload, overwrite_id: editingViewId})
            });
            const js=await res.json(); if(!res.ok||!js?.ok){ alert(js?.error||'Falha ao atualizar vis√£o.'); return; }
            toast('Vis√£o atualizada.');
          }else{
            const state=await snapshotCurrentState();
            const res=await fetch(URL_VIEWS_SAVE,{
              method:'POST',
              headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
              body:JSON.stringify({...payload, state})
            });
            const js=await res.json(); if(!res.ok||!js?.ok){
              const err=js?.error||'Falha ao salvar vis√£o.';
              if(err==='duplicate_name') alert('J√° existe uma vis√£o sua com este nome.');
              else alert(err);
              return;
            }
            toast('Vis√£o salva.');
          }

          closeModal();
          await loadSavedViews();
        }catch{ alert('Erro ao salvar/atualizar vis√£o.'); }
        finally{ btnSaveModalSubmit.disabled=false; }
      }

      // ========= MENU ‚ÄúExibi√ß√£o ‚ñæ‚Äù ‚Äî portal + scrim =========
      const btnView  = document.getElementById('btnView');
      const menuView = document.getElementById('menuView');
      let viewScrim = null;

      function placeMenuNearButton(menuEl, btnEl, offsetY = 6){
        const r = btnEl.getBoundingClientRect();
        menuEl.style.display = 'block';
        const mw = Math.max(220, menuEl.offsetWidth || 220);
        const top  = Math.round(r.bottom + offsetY + window.scrollY);
        const left = Math.round(r.right - mw + window.scrollX);
        menuEl.style.minWidth = mw + 'px';
        menuEl.style.top  = top  + 'px';
        menuEl.style.left = left + 'px';
      }

      function openViewMenu(){
        if (!viewScrim){
          viewScrim = document.createElement('div');
          viewScrim.className = 'menu-scrim';
          viewScrim.addEventListener('pointerdown', closeViewMenu);
          document.body.appendChild(viewScrim);
        }
        if (menuView.parentElement !== document.body){
          document.body.appendChild(menuView);
        }
        menuView.classList.add('open');
        placeMenuNearButton(menuView, btnView);
        btnView.setAttribute('aria-expanded', 'true');
      }
      function closeViewMenu(){
        if (!menuView.classList.contains('open')){
          if (viewScrim){ viewScrim.remove(); viewScrim = null; }
          return;
        }
        menuView.classList.remove('open');
        menuView.style.display = 'none';   // <-- garante esconder
        btnView.setAttribute('aria-expanded', 'false');
        if (viewScrim){ viewScrim.remove(); viewScrim = null; }
      }

      btnView.addEventListener('click', () => {
        const willOpen = !menuView.classList.contains('open');
        if (willOpen) openViewMenu(); else closeViewMenu();
      }, { passive: true });

      // Reposiciona em resize/scroll
      window.addEventListener('resize', () => {
        if (menuView.classList.contains('open')) placeMenuNearButton(menuView, btnView);
      }, { passive:true });
      window.addEventListener('scroll', () => {
        if (menuView.classList.contains('open')) placeMenuNearButton(menuView, btnView);
      }, { passive:true });

      // ESC fecha
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeViewMenu();
      }, true);

      // Clique nas op√ß√µes do menu Exibi√ß√£o
      menuView.addEventListener('click', async (e) => {
        const el = e.target.closest('.btndrop');
        if (!el) return;
        const opt = (el.getAttribute('data-view') || '').toLowerCase();
        try{
          if (!window.powerbi || !report) throw new Error('Report n√£o pronto');
          const displayMap = {
            'fittopage':  models.DisplayOption.FitToPage,
            'fittowidth': models.DisplayOption.FitToWidth,
            'actualsize': models.DisplayOption.ActualSize,
          };
          const displayOption = displayMap[opt];
          if (displayOption == null) return;

          await report.updateSettings({
            layoutType:  models.LayoutType.Custom,
            customLayout:{ displayOption }
          });

          if (typeof toast === 'function') {
            toast(opt === 'fittopage'  ? 'Ajustado √† p√°gina.'
                : opt === 'fittowidth' ? 'Ajustado √† largura.'
                : 'Tamanho real (1:1).');
          }
        } catch (err){
          (console.error || console.log)?.('[Exibi√ß√£o] erro ao aplicar', err);
          alert('N√£o foi poss√≠vel aplicar a exibi√ß√£o agora.');
        } finally {
          closeViewMenu(); // fecha ap√≥s escolher
        }
      });

      // ====== MENU "Vis√µes" com portal + SCRIM ======
      const btnViews_onReposition = () => {
        if (menuViews && menuViews.classList.contains('open')) placeMenuNearButton(menuViews, btnViews);
      };
      const onEsc = (e) => { if (e.key === 'Escape') closeViewsMenu(); };

      function bindOutsideHandlers(){
        window.addEventListener('resize', btnViews_onReposition, { passive:true });
        window.addEventListener('scroll', btnViews_onReposition, { passive:true });
        document.addEventListener('keydown', onEsc, true);
        window.addEventListener('blur', closeViewsMenu, { passive:true });
      }
      function unbindOutsideHandlers(){
        window.removeEventListener('resize', btnViews_onReposition);
        window.removeEventListener('scroll', btnViews_onReposition);
        document.removeEventListener('keydown', onEsc, true);
        window.removeEventListener('blur', closeViewsMenu);
      }

      function openViewsMenu(){
        if (!viewsScrim){
          viewsScrim = document.createElement('div');
          viewsScrim.className = 'menu-scrim';
          viewsScrim.addEventListener('pointerdown', closeViewsMenu);
          document.body.appendChild(viewsScrim);
        }
        if (menuViews.parentElement !== document.body){
          document.body.appendChild(menuViews);
        }
        menuViews.classList.add('open');
        placeMenuNearButton(menuViews, btnViews);
        btnViews.setAttribute('aria-expanded', 'true');
        bindOutsideHandlers();
        setTimeout(() => viewsSearch?.focus(), 0);
      }
      function closeViewsMenu(){
        if (!menuViews.classList.contains('open')) {
          if (viewsScrim){ viewsScrim.remove(); viewsScrim=null; }
          return;
        }
        menuViews.classList.remove('open');
        menuViews.style.display = 'none';
        btnViews.setAttribute('aria-expanded', 'false');
        unbindOutsideHandlers();
        if (viewsScrim){
          viewsScrim.removeEventListener('pointerdown', closeViewsMenu);
          viewsScrim.remove();
          viewsScrim = null;
        }
      }

      // Bot√£o "Vis√µes"
      btnViews.addEventListener('click', async () => {
        const willOpen = !menuViews.classList.contains('open');
        if (willOpen && !cachedViews.length) await loadSavedViews();
        if (willOpen) openViewsMenu(); else closeViewsMenu();
      }, { passive: true });

      // filtro e recarregar
      viewsSearch.addEventListener('input', () => renderViewsList(viewsSearch.value));
      viewsSearch.addEventListener('keydown', (e) => {
        if (e.key === 'Enter'){
          const first = (cachedViews || []).find(v => v.name.toLowerCase().includes((viewsSearch.value||'').toLowerCase()));
          if (first) { closeViewsMenu(); applySavedView(first.id); }
        }
      });
      btnReloadViews.addEventListener('click', loadSavedViews);

      // Modal salvar/editar vis√£o
      btnSaveView.addEventListener('click', openModalForCreate, { passive: true });
      btnCloseSaveModal.addEventListener('click', closeModal, { passive: true });
      btnSaveModalCancel.addEventListener('click', closeModal, { passive: true });
      btnSaveModalSubmit.addEventListener('click', submitSaveOrUpdate);

      document.getElementById('btnFull').addEventListener('click', () => { try{ report && report.fullscreen(); }catch(e){ log('error','fullscreen fail', e); } }, { passive: true });
      document.getElementById('btnReset').addEventListener('click', resetAll, { passive: true });
      document.getElementById('btnRefreshNow').addEventListener('click', forceRefreshNow, { passive: true });

      // Sonda/poll badge & status
      updateLastUpdBadge();
      refreshLastUpdBadgeRt();
      setInterval(updateLastUpdBadge,    60 * 1000);
      setInterval(refreshLastUpdBadgeRt, 5  * 60 * 1000);

      // Ao voltar para a aba/ganhar foco ‚Üí checagem imediata
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          refreshLastUpdBadgeRt();
          probeRefreshStart();
        }
      }, { passive: true });
      window.addEventListener('focus', () => {
        refreshLastUpdBadgeRt();
        probeRefreshStart();
      }, { passive: true });

      // Boot
      embedReportPhased(INITIAL_URL, INITIAL_TOKEN);
      tokenRefreshTimer = setInterval(refreshAccessTokenLoop, REFRESH_MS);

      // primeiro ciclo ‚Äúquente‚Äù da sonda adaptativa
      scheduleAdaptiveProbe();
      probeRefreshStart(); // ‚Üê ajusta pill e mostra/oculta o bot√£o logo na entrada
    })();
  </script>
{% endblock %}

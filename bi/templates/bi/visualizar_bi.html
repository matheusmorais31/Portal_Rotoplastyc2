{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/visualizar_bi.css' %}">
{% endblock %}

{% block content %}
  <!-- Contêiner do relatório Power BI -->
  <div id="reportContainer" class="h-full w-full"></div>

  <!-- Power BI Client SDK -->
  <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.19.1/dist/powerbi.min.js"></script>
  <script>
    (() => {
      const models   = window['powerbi-client'].models;
      const reportId = '{{ report_id }}';
      const groupId  = '{{ bi_report.group_id }}';
      const csrftoken = '{{ csrf_token }}';

      /**
       * Embeds the report and wires up auto‑renewal when the token expires.
       * @param {string} embedUrl  - URL fornecida pela API Power BI.
       * @param {string} embedToken – EmbedToken válido por ~60 min.
       */
      function embedReport (embedUrl, embedToken) {
        const config = {
          type: 'report',
          id:   reportId,
          embedUrl,
          accessToken: embedToken,
          tokenType:   models.TokenType.Embed,
          permissions: models.Permissions.View,
          settings: {
            panes: {
              filters:        { visible: true },
              pageNavigation: { visible: true }
            },
            navContentPaneEnabled: true,
            layoutType: models.LayoutType.Custom,
            customLayout: { displayOption: models.DisplayOption.FitToPage }
          }
        };

        const container = document.getElementById('reportContainer');
        powerbi.reset(container);
        const report = powerbi.embed(container, config);

        // ️♻️  Auto‑refresh token quando expirar (evento nativo do SDK)
        report.on('tokenExpired', () => {
          fetch('{% url "bi:get_embed_params" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ report_id: reportId, group_id: groupId })
          })
          .then(res => res.json())
          .then(data => {
            if (data.embed_token) {
              report.setAccessToken(data.embed_token);
            } else {
              console.error('Falha ao obter novo embed_token', data);
              alert('Sessão expirada. Recarregue a página.');
            }
          })
          .catch(err => {
            console.error('Erro ao renovar embed_token', err);
            alert('Erro na renovação da sessão. Recarregue a página.');
          });
        });
      }

      // Embed inicial
      embedReport('{{ embed_url }}', '{{ embed_token }}');
    })();
  </script>
{% endblock %}

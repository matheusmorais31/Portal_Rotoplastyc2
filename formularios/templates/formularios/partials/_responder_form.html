{% load static %}
<link rel="stylesheet" href="{% static 'responder.css' %}">

<div class="form-wrapper">
    <div class="cabecalho-card">
        <h1>{{ formulario.titulo }}</h1>
        {% if formulario.descricao %}
        <p class="form-descricao">{{ formulario.descricao|linebreaksbr }}</p>
        {% endif %}
    </div>

    <form method="post"
          action="{% url 'formularios:enviar_resposta_formulario' formulario.pk %}{% if embed or request.GET.embed == '1' %}?embed=1{% endif %}"
          enctype="multipart/form-data"
          novalidate>
        {% csrf_token %}
        {% if embed or request.GET.embed == '1' %}
        <input type="hidden" name="__embed" value="1">
        {% endif %}

        {% if erros or nome_erros %}
        <div class="pergunta-card" style="border-color:#ff4d4f">
            <strong style="color:#ff9191;display:block;margin-bottom:.5rem">Corrija os itens abaixo:</strong>
            <ul style="margin-left:1rem;line-height:1.35">
                {% for e in erros %}<li>{{ e }}</li>{% empty %}{% endfor %}
                {% for e in nome_erros %}<li>{{ e }}</li>{% empty %}{% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if formulario.coletar_nome and not request.user.is_authenticated %}
        <div class="pergunta-card required {% if nome_erros %}has-error{% endif %}">
            <div class="pergunta-header">
                <label for="campo-nome">Seu nome</label>
                <small class="texto-ajuda">Informe seu nome para registrar a resposta.</small>
            </div>
            <div class="pergunta-body">
                <input type="text"
                       name="__nome__"
                       id="campo-nome"
                       class="input-texto"
                       placeholder="Seu nome completo"
                       value="{{ nome_informado|default_if_none:'' }}"
                       aria-invalid="{% if nome_erros %}true{% else %}false{% endif %}"
                       required>
                {% if nome_erros %}
                <ul class="field-errors">
                    {% for e in nome_erros %}<li>{{ e }}</li>{% empty %}{% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# ===================== CAMPOS ATIVOS ===================== #}
        {% for campo in formulario.campos.all %}
        {% if campo.ativo %}
        <div class="pergunta-card {% if campo.obrigatorio %}required{% endif %} {% if campo.errors %}has-error{% endif %}">
            <div class="pergunta-header">
                <label for="campo-{{ campo.id }}">
                    {{ campo.rotulo }}{% if campo.obrigatorio %}<span class="asterisk">*</span>{% endif %}
                </label>
                {% if campo.ajuda %}
                <small class="texto-ajuda">{{ campo.ajuda }}</small>
                {% endif %}
            </div>

            <div class="pergunta-body">
                {% if campo.tipo == "texto_curto" %}
                <input type="text"
                       name="{{ campo.id }}"
                       id="campo-{{ campo.id }}"
                       class="input-texto"
                       placeholder="Sua resposta"
                       value="{{ campo.posted|default_if_none:'' }}"
                       aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}"
                       {% if campo.obrigatorio %}required{% endif %}>
                {% elif campo.tipo == "paragrafo" %}
                <textarea name="{{ campo.id }}"
                          id="campo-{{ campo.id }}"
                          rows="4"
                          class="input-texto"
                          placeholder="Sua resposta"
                          aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}"
                          {% if campo.obrigatorio %}required{% endif %}>{{ campo.posted|default_if_none:'' }}</textarea>
                {% elif campo.tipo == "multipla" %}
                <div class="options-block radios" aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}">
                    {% for opcao in campo.opcoes.all %}
                    {% with val_op=opcao.valor|default:opcao.texto %}
                    <label class="option">
                        <input type="radio"
                               name="{{ campo.id }}"
                               value="{{ val_op }}"
                               {% if campo.posted == val_op %}checked{% endif %}
                               {% if campo.obrigatorio %}required{% endif %}>
                        {{ opcao.texto }}
                    </label>
                    {% endwith %}
                    {% empty %}
                    <div class="texto-ajuda">Sem opções.</div>
                    {% endfor %}
                </div>
                {% elif campo.tipo == "checkbox" %}
                <div class="options-block checks" aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}">
                    {% for opcao in campo.opcoes.all %}
                    {% with val_op=opcao.valor|default:opcao.texto %}
                    <label class="option">
                        <input type="checkbox"
                               name="{{ campo.id }}"
                               value="{{ val_op }}"
                               {% if campo.posted_multi and val_op in campo.posted_multi %}checked{% endif %}>
                        {{ opcao.texto }}
                    </label>
                    {% endwith %}
                    {% empty %}
                    <div class="texto-ajuda">Sem opções.</div>
                    {% endfor %}
                </div>

                {# ========= LISTA (SELECT) ========= #}
                {% elif campo.tipo == "lista" %}
                {% with lj=campo.logica_json %}
                {% with opts=lj.options|default:lj %}
                {% with sql=opts.sqlhub %}
                {% firstof opts.source lj.source campo.origem_opcoes "manual" as origem_raw %}
                {% with origem=origem_raw|lower %}
                {% firstof sql.query_id sql.query campo.sqlhub_query_id "" as qid %}
                {% firstof sql.value_field sql.value campo.sqlhub_value_field "" as vf %}
                {% firstof sql.label_field sql.label campo.sqlhub_label_field "" as lf %}

                {% if origem == "sqlhub" or qid %}
                <select name="{{ campo.id }}"
                        id="campo-{{ campo.id }}"
                        class="input-select sqlhub-select"
                        data-sqlhub="1"
                        data-qid="{{ qid }}"
                        data-vf="{{ vf }}"
                        data-lf="{{ lf }}"
                        data-selected="{{ campo.posted|default_if_none:'' }}"
                        aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}"
                        {% if campo.obrigatorio %}required{% endif %}>
                    <option value="">Carregando…</option>
                </select>
                <script>
                    console.log('[RESP] lista via SQLHub → campo {{ campo.id }}', {
                        id: '{{ campo.id }}',
                        origem: '{{ origem }}',
                        qid: '{{ qid }}',
                        vf: '{{ vf|escapejs }}',
                        lf: '{{ lf|escapejs }}',
                        selected: '{{ campo.posted|default_if_none:""|escapejs }}'
                    });
                </script>
                {% else %}
                <select name="{{ campo.id }}"
                        id="campo-{{ campo.id }}"
                        class="input-select"
                        aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}"
                        {% if campo.obrigatorio %}required{% endif %}>
                    <option value="" disabled {% if not campo.posted %}selected{% endif %}>Escolha…</option>
                    {% for opcao in campo.opcoes.all %}
                    {% with val_op=opcao.valor|default:opcao.texto %}
                    <option value="{{ val_op }}" {% if campo.posted == val_op %}selected{% endif %}>
                        {{ opcao.texto }}
                    </option>
                    {% endwith %}
                    {% empty %}
                    <option value="" disabled>Sem opções.</option>
                    {% endfor %}
                </select>
                <script>
                    console.log('[RESP] lista manual → campo {{ campo.id }}', {
                        id: '{{ campo.id }}',
                        origem: '{{ origem }}',
                        qid: '{{ qid }}',
                        opts: {{ campo.opcoes.count|default:0 }}
                    });
                </script>
                {% endif %}

                {% endwith %}
                {% endwith %}
                {% endwith %}
                {% endwith %}

                {% elif campo.tipo == "escala" %}
                <div class="options-block radios escala" aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}">
                    {% for i in "12345678910"|make_list %}
                    {% if forloop.counter <= 10 %}
                    <label class="option">
                        <input type="radio"
                               name="{{ campo.id }}"
                               value="{{ forloop.counter }}"
                               {% if campo.posted == forloop.counter|stringformat:"s" %}checked{% endif %}
                               {% if campo.obrigatorio %} required{% endif %}>
                        <span class="scale-num">{{ forloop.counter }}</span>
                    </label>
                    {% endif %}
                    {% empty %}{% endfor %}
                </div>

                {% elif campo.tipo == "data" %}
                <input type="date"
                       name="{{ campo.id }}"
                       id="campo-{{ campo.id }}"
                       class="input-texto"
                       value="{{ campo.posted|default_if_none:'' }}"
                       aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}"
                       {% if campo.obrigatorio %}required{% endif %}>
                {% elif campo.tipo == "hora" %}
                <input type="time"
                       name="{{ campo.id }}"
                       id="campo-{{ campo.id }}"
                       class="input-texto"
                       value="{{ campo.posted|default_if_none:'' }}"
                       aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}"
                       {% if campo.obrigatorio %}required{% endif %}>
                {% elif campo.tipo == "arquivo" %}
                {% with cfg=campo.validacao_json %}
                <div class="multi-uploader {% if campo.errors %}has-error{% endif %}"
                     data-name="{{ campo.id }}"
                     data-accept="{{ campo.accept_string|default_if_none:'' }}"
                     data-max="{{ cfg.max_arquivos|default:1 }}"
                     data-required="{% if campo.obrigatorio %}1{% else %}0{% endif %}">
                    <div class="fu-input-holder" aria-invalid="{% if campo.errors %}true{% else %}false{% endif %}">
                        <noscript>
                            <input type="file"
                                   name="{{ campo.id }}"
                                   class="input-file"
                                   accept="{{ campo.accept_string|default_if_none:'' }}"
                                   {% if cfg.max_arquivos and cfg.max_arquivos > 1 %}multiple{% endif %}
                                   {% if campo.obrigatorio %}required{% endif %}>
                        </noscript>
                    </div>

                    <small class="texto-ajuda">
                        {% if cfg.max_arquivos %}Máx {{ cfg.max_arquivos }} arquivo(s). {% endif %}
                        {% if cfg.max_mb %}{{ cfg.max_mb }} MB cada. {% endif %}
                        {% if cfg and not cfg.tipos_livres and cfg.categorias %} Tipos permitidos: {{ cfg.categorias|join:", " }}. {% endif %}
                        <span class="fu-hint-max">Selecionados: <span class="fu-count">0</span></span>
                        {% if campo.errors %}<br>Atenção: por segurança do navegador, os arquivos precisam ser selecionados novamente.{% endif %}
                    </small>

                    <ul class="fu-list"></ul>
                    <div class="fu-bucket" aria-hidden="true" style="display:none"></div>
                </div>
                {% endwith %}

                {% else %}
                <p class="campo-nao-suportado">Tipo de campo ‘{{ campo.get_tipo_display }}’ não suportado.</p>
                {% endif %}

                {% if campo.errors %}
                <ul class="field-errors">
                    {% for e in campo.errors %}<li>{{ e }}</li>{% empty %}{% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% empty %}{% endfor %}

        <div class="btn-group">
            <button type="submit" class="btn-primario">Enviar</button>
        </div>
    </form>
</div>

<script>
(function () {
    const LOG = true;

    const L = {
        group(label, collapsed = true) {
            if (!LOG) return { end() {} };
            (collapsed ? console.groupCollapsed : console.group).call(console, label);
            return { end: () => console.groupEnd() };
        },
        log(...a) { LOG && console.log('[SS]', ...a); },
        warn(...a) { LOG && console.warn('[SS]', ...a); },
        error(...a) { LOG && console.error('[SS]', ...a); },
    };

    const CANDS = (qid) => [
        `/sqlhub/api/query/${qid}/options/`,
        `/sqlhub/api/queries/${qid}/options/`,
        `/sqlhub/queries/${qid}/options/`
    ];

    function buildUrls(qid, vf, lf, { limit = '200' } = {}) {
        const out = [];
        const add = (u, strict = true) => {
            if (strict) {
                u.searchParams.set('value_field', vf);
                u.searchParams.set('label_field', lf);
            } else {
                u.searchParams.set('value', vf);
                u.searchParams.set('label', lf);
            }
            ['limit', 'page_size', 'per_page', 'size', 'max', 'top'].forEach(k => u.searchParams.set(k, limit));
        };
        for (const base of CANDS(qid)) {
            const s = new URL(base, location.origin);
            add(s, true);
            out.push({ url: s, strict: true });
            const l = new URL(base, location.origin);
            add(l, false);
            out.push({ url: l, strict: false });
        }
        return out;
    }

    async function fetchJson(u, controller) {
        const g = L.group(`[GET] ${u.pathname}${u.search}`, true);
        try {
            const r = await fetch(u, {
                headers: { 'X-Requested-With': 'fetch', 'Accept': 'application/json' },
                signal: controller?.signal
            });
            L.log('→', u.href, 'status', r.status, r.statusText);
            if (!r.ok) { g.end(); return [false, null]; }
            const j = await r.json().catch(() => null);
            if (j && typeof j === 'object') L.log('json keys', Object.keys(j));
            g.end();
            return [true, j];
        } catch (e) {
            if (e.name === 'AbortError') L.warn('abort', u.href);
            else L.warn('fetch error', e);
            g.end();
            return [false, null];
        }
    }

    function normalize(json, vf, lf) {
        const rows = Array.isArray(json?.rows) ? json.rows
            : Array.isArray(json?.data) ? json.data
            : Array.isArray(json?.results) ? json.results
            : (Array.isArray(json) ? json : null);
        const arr = rows || json?.options || [];
        if (!Array.isArray(arr)) return [];
        return arr.map(r => {
            const ref = r?.REFERENCIA ?? r?.referencia;
            const desc = r?.DESCRICAO ?? r?.descricao;
            const labelPref = ref
                ? (desc ? `${ref} — ${desc}` : String(ref))
                : (r?.[lf] ?? r?.label ?? r?.name ?? r?.[vf]);
            return {
                value: String(r?.[vf] ?? r?.value ?? r?.id ?? ''),
                label: String(labelPref ?? ''),
                raw: r
            };
        }).filter(x => x.value !== '');
    }

    /* ============ UI PESQUISÁVEL ============ */
    function enhanceSearchable(select) {
        if (!select || select.dataset.enhanced === "1") return;
        select.dataset.enhanced = "1";

        const wrap = document.createElement('div');
        wrap.className = 'ss';
        select.parentNode.insertBefore(wrap, select);
        wrap.appendChild(select);

        const box = document.createElement('div');
        box.className = 'ss-box';

        const input = document.createElement('input');
        input.type = 'search';
        input.className = 'ss-input';
        input.placeholder = 'Pesquisar...';

        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'ss-clear';
        clearBtn.title = 'Limpar';
        clearBtn.innerHTML = '×';

        box.appendChild(input);
        box.appendChild(clearBtn);

        const drop = document.createElement('div');
        drop.className = 'ss-dropdown';
        drop.hidden = true;

        const list = document.createElement('ul');
        list.className = 'ss-list';
        drop.appendChild(list);

        const status = document.createElement('div');
        status.className = 'ss-status';
        drop.appendChild(status);

        wrap.insertBefore(box, select);
        wrap.insertBefore(drop, select);
        select.classList.add('ss-hidden');

        const norm = s => String(s || '').normalize('NFD').replace(/\p{Diacritic}/gu, '').toLowerCase();
        const alnum = s => norm(s).replace(/[^a-z0-9]/g, '');
        const MAX_SUG = 100;

        function li(text, cls = 'ss-empty') {
            const el = document.createElement('li');
            el.className = cls;
            el.textContent = text;
            return el;
        }

        function setStatus(txt) {
            status.textContent = txt || '';
            status.style.display = txt ? 'block' : 'none';
        }

        function buildLocal() {
            const arr = [];
            for (const opt of select.options) {
                if (!opt.value) continue;
                arr.push({ value: opt.value, label: opt.text });
            }
            return arr;
        }

        let LOCAL = buildLocal();
        const vf = select.dataset.vf || '';
        const lf = select.dataset.lf || '';
        let remoteBase = select.dataset.sqlhubBase || '';

        if (!remoteBase && select.dataset.qid) {
            remoteBase = CANDS(select.dataset.qid)[0];
            select.dataset.sqlhubBase = remoteBase;
        }

        L.log('enhanceSearchable/base', remoteBase, { vf, lf });

        let currentSearch = { ctl: null, seq: 0 };

        function renderLocal(q = '') {
            list.innerHTML = '';
            const nq = norm(q), aq = alnum(q);
            const data = q ? LOCAL.filter(o =>
                norm(o.label).includes(nq) ||
                norm(o.value).includes(nq) ||
                alnum(o.label).includes(aq) ||
                alnum(o.value).includes(aq)
            ) : LOCAL.slice(0, MAX_SUG);

            if (!data.length) {
                list.appendChild(li('Nenhum resultado'));
                drop.hidden = false;
                setStatus('');
                return;
            }

            data.slice(0, MAX_SUG).forEach(o => {
                const item = document.createElement('li');
                item.className = 'ss-item';
                item.setAttribute('role', 'option');
                item.dataset.value = o.value;
                item.dataset.label = o.label;
                item.innerHTML = `<span class="ss-label">${o.label}</span><span class="ss-value">${o.value}</span>`;
                item.addEventListener('mousedown', (ev) => {
                    ev.preventDefault();
                    choose(o.value, o.label);
                });
                list.appendChild(item);
            });

            drop.hidden = false;
            setStatus('');
        }

        function ensureOption(value, label) {
            let opt = Array.from(select.options).find(o => o.value === String(value));
            if (!opt) {
                opt = document.createElement('option');
                opt.value = String(value);
                opt.textContent = String(label ?? value);
                select.appendChild(opt);
                LOCAL = buildLocal();
            }
            return opt;
        }

        function choose(value, label, ensure = false) {
            if (ensure) ensureOption(value, label);
            select.value = String(value);
            input.value = String(label || value);
            drop.hidden = true;
        }

        function filterByQuery(list, q) {
            const nq = norm(q), aq = alnum(q);
            return list.filter(o => {
                const Ltxt = String(o.label || '');
                const Vtxt = String(o.value || '');
                const raw = o.raw || {};
                const ref = String(raw.REFERENCIA ?? raw.referencia ?? '');
                const desc = String(raw.DESCRICAO ?? raw.descricao ?? '');
                return (
                    norm(Ltxt).includes(nq) ||
                    norm(Vtxt).includes(nq) ||
                    alnum(Ltxt).includes(aq) ||
                    alnum(Vtxt).includes(aq) ||
                    norm(ref).includes(nq) ||
                    norm(desc).includes(nq) ||
                    alnum(ref).includes(aq)
                );
            });
        }

        function getNextUrl(payload, baseUrl) {
            let nx = payload?.next || payload?.links?.next || payload?.pagination?.next
                || payload?.meta?.next || payload?.next_page_url || payload?.nextPageUrl;
            if (!nx) return null;
            try { return new URL(nx, location.origin); }
            catch {
                try { return new URL(String(nx), new URL(baseUrl, location.origin)); }
                catch { return null; }
            }
        }

        // ============ BUSCA REMOTA ============ 
        async function remoteSearch(q, limit = '120') {
            if (!remoteBase || !q) return [];
            currentSearch.ctl?.abort();
            const ctl = new AbortController();
            const mySeq = ++currentSearch.seq;
            currentSearch.ctl = ctl;
            const attempts = [];
            const push = (tag, u) => attempts.push({ tag, u });

            // tentativas rápidas
            let u = new URL(remoteBase, location.origin);
            u.searchParams.set('value_field', vf);
            u.searchParams.set('label_field', lf);
            u.searchParams.set('q', q);
            ['limit', 'page_size', 'per_page', 'size', 'max', 'top'].forEach(k => u.searchParams.set(k, limit));
            push('strict q', u);

            u = new URL(remoteBase, location.origin);
            u.searchParams.set('value', vf);
            u.searchParams.set('label', lf);
            u.searchParams.set('q', q);
            ['limit', 'page_size', 'per_page', 'size', 'max', 'top'].forEach(k => u.searchParams.set(k, limit));
            push('legacy q', u);

            for (const field of ['REFERENCIA', 'referencia', 'DESCRICAO', 'descricao']) {
                u = new URL(remoteBase, location.origin);
                u.searchParams.set('value_field', vf);
                u.searchParams.set('label_field', lf);
                u.searchParams.set(`${field}_like`, `%${q}%`);
                ['limit', 'page_size', 'per_page', 'size', 'max', 'top'].forEach(k => u.searchParams.set(k, limit));
                push(`strict ${field}_like`, u);
            }

            for (const { tag, u: uu } of attempts) {
                setStatus('Procurando…');
                const [ok, payload] = await fetchJson(uu, ctl);
                if (mySeq !== currentSearch.seq) return [];
                if (!ok) continue;
                const list = normalize(payload, vf, lf);
                const filtered = filterByQuery(list, q);
                L.log('remote attempt:', tag, 'orig=', list.length, 'filtered=', filtered.length);
                if (filtered.length) return filtered;
            }

            // fallback paginado (DRF-like)
            const PAGE_SIZE = 200;
            const MAX_PAGES = 300;
            const seen = new Set();
            let page = 1;
            let pageUrl = new URL(remoteBase, location.origin);
            pageUrl.searchParams.set('value_field', vf);
            pageUrl.searchParams.set('label_field', lf);
            ['limit', 'page_size', 'per_page', 'size', 'max', 'top'].forEach(k => pageUrl.searchParams.set(k, PAGE_SIZE));

            while (page <= MAX_PAGES) {
                setStatus(`Procurando… (página ${page})`);
                const key = pageUrl.pathname + pageUrl.search;
                if (seen.has(key)) {
                    L.warn('scan next repetido, encerrando');
                    break;
                }
                seen.add(key);
                const [ok, payload] = await fetchJson(pageUrl, ctl);
                if (mySeq !== currentSearch.seq) return [];
                if (!ok || !payload) break;
                const list = normalize(payload, vf, lf);
                L.log('scan next page', page, 'count=', list.length);
                const filtered = filterByQuery(list, q);
                if (filtered.length) {
                    L.log('scan next HIT page', page, 'filtered=', filtered.length);
                    return filtered;
                }
                const nxt = getNextUrl(payload, pageUrl.href);
                if (!nxt) { L.log('scan next EOF'); break; }
                pageUrl = nxt;
                page++;
            }

            setStatus('');
            L.warn('remoteSearch: nenhuma tentativa / página retornou resultado');
            return [];
        }

        async function renderRemote(q) {
            list.innerHTML = '';
            list.appendChild(li('Procurando…'));
            drop.hidden = false;
            const data = await remoteSearch(q, '120');
            if (currentSearch.ctl?.signal?.aborted) return;
            list.innerHTML = '';
            setStatus('');
            if (!data.length) {
                list.appendChild(li('Nenhum resultado'));
                return;
            }
            data.forEach(o => {
                const it = document.createElement('li');
                it.className = 'ss-item';
                it.setAttribute('role', 'option');
                it.dataset.value = o.value;
                it.dataset.label = o.label || o.value;
                it.innerHTML = `<span class="ss-label">${o.label || o.value}</span><span class="ss-value">${o.value}</span>`;
                it.addEventListener('mousedown', (ev) => {
                    ev.preventDefault();
                    choose(o.value, o.label || o.value, true);
                });
                list.appendChild(it);
            });
        }

        if (select.value) {
            const opt = select.options[select.selectedIndex];
            if (opt) input.value = opt.text;
        }

        let debounce;
        function trigger() {
            const q = input.value.trim();
            clearTimeout(debounce);
            debounce = setTimeout(() => {
                if (q.length >= 2 && remoteBase) {
                    renderRemote(q);
                } else {
                    currentSearch.ctl?.abort();
                    renderLocal(q);
                }
            }, 220);
        }

        input.addEventListener('focus', trigger);
        input.addEventListener('input', trigger);

        input.addEventListener('keydown', (e) => {
            const items = Array.from(list.querySelectorAll('.ss-item'));
            const focused = document.activeElement;
            const idx = items.indexOf(focused);
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                (items[idx + 1] || items[0] || input).focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                (items[idx - 1] || items[items.length - 1] || input).focus();
            } else if (e.key === 'Enter') {
                if (focused && focused.classList.contains('ss-item')) {
                    e.preventDefault();
                    choose(focused.dataset.value, focused.dataset.label, true);
                } else {
                    const match = Array.from(select.options).find(o => o.text === input.value);
                    if (match) choose(match.value, match.text);
                    drop.hidden = true;
                }
            } else if (e.key === 'Escape') {
                currentSearch.ctl?.abort();
                drop.hidden = true;
                input.blur();
            }
        });

        clearBtn.addEventListener('click', () => {
            currentSearch.ctl?.abort();
            input.value = '';
            select.value = '';
            renderLocal('');
            input.focus();
        });

        document.addEventListener('click', (e) => {
            if (!wrap.contains(e.target)) {
                currentSearch.ctl?.abort();
                drop.hidden = true;
            }
        });

        const mo = new MutationObserver(() => { LOCAL = buildLocal(); });
        mo.observe(select, { childList: true, subtree: true, characterData: true });
    }

    /* ============ Hidratação inicial (200 mais usados) ============ */
    async function hydrateSelect(sel) {
        const qid = (sel.dataset.qid || '').trim();
        const vf = (sel.dataset.vf || '').trim();
        const lf = (sel.dataset.lf || '').trim();
        const selected = String(sel.dataset.selected ?? '');
        if (!qid || !vf || !lf) {
            sel.innerHTML = '<option value="" disabled selected>Configuração inválida (qid/vf/lf)</option>';
            return;
        }
        sel.disabled = true;
        sel.innerHTML = '<option value="">Carregando…</option>';
        try {
            let usedHref = null, data = [];
            for (const cand of buildUrls(qid, vf, lf, { limit: '200' })) {
                const [ok, payload] = await fetchJson(cand.url);
                if (!ok) continue;
                const list = normalize(payload, vf, lf);
                if (!list.length) continue;
                usedHref = cand.url.href;
                data = list;
                break;
            }
            if (!data.length) {
                sel.innerHTML = '<option value="" disabled selected>Nenhuma opção disponível</option>';
            } else {
                // placeholder selecionado quando não há valor prévio
                sel.innerHTML = '';
                const ph = document.createElement('option');
                ph.value = '';
                ph.textContent = 'Escolha…';
                ph.disabled = true;
                if (!selected) ph.selected = true;
                sel.appendChild(ph);

                data.forEach(o => {
                    const op = document.createElement('option');
                    op.value = String(o.value ?? '');
                    op.textContent = String(o.label ?? o.value ?? '');
                    if (selected && selected === op.value) op.selected = true;
                    sel.appendChild(op);
                });

                if (!selected) {
                    sel.value = '';
                    sel.selectedIndex = 0;
                }
            }

            if (usedHref) {
                const u = new URL(usedHref, location.origin);
                sel.dataset.sqlhubBase = u.pathname;
            } else {
                sel.dataset.sqlhubBase = CANDS(qid)[0];
            }
        } catch (e) {
            sel.innerHTML = '<option value="" disabled selected>Falha ao carregar opções</option>';
        } finally {
            sel.disabled = false;
            enhanceSearchable(sel);
        }
    }

    function initSqlhub(container) {
        (container || document).querySelectorAll('select.sqlhub-select[data-sqlhub="1"]').forEach(hydrateSelect);
    }

    document.addEventListener('DOMContentLoaded', () => {
        initSqlhub(document);
        document.querySelectorAll('select.input-select:not(.sqlhub-select)').forEach(enhanceSearchable);
    });

    document.addEventListener('htmx:afterSwap', e => initSqlhub(e.target));
})();
</script>

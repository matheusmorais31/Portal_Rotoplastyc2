{% load static %}
{% url 'sqlhub:api_connections' as url_sqlhub_conns %}
{% url 'sqlhub:api_queries' as url_sqlhub_queries %}

<div class="pergunta-card" id="pergunta-{{ subform.prefix }}" data-prefix="{{ subform.prefix }}">
  {{ subform.id }}{{ subform.DELETE }}{{ subform.ordem }}

  <div class="pergunta-head">
    <span class="drag-handle" title="Arrastar">‚ò∞</span>

    {# NOVO: badge de alerta #}
    <span class="card-flag warn hide" title="Configura√ß√£o incompleta">‚ö† Config incompleta</span>

    <label class="toggle-label obrig-toggle" title="Tornar esta pergunta obrigat√≥ria">
      {{ subform.obrigatorio }}<span class="toggle-custom"></span>
      <span class="lbl-text">Obrigat√≥rio</span>
    </label>

    <!-- Duplicar pergunta (√≠cone PNG) -->
    <button type="button" class="btn-dup icon-btn" title="Duplicar" aria-label="Duplicar">
      <img
        src="{% static 'images/versao.png' %}"
        srcset="{% static 'images/versao.png' %} 1x, {% static 'images/versao@2x.png' %} 2x"
        alt="" width="20" height="20" decoding="async">
    </button>

    <button type="button" class="btn-trash" title="Remover"
            onclick="
              const c=this.closest('.pergunta-card');
              c.querySelector('input[name$=-DELETE]').checked=true;
              c.style.display='none';
              document.dispatchEvent(new CustomEvent('rowDeleted'));
              triggerAutosave?.();
            ">üóëÔ∏è</button>
  </div>

  <div class="pergunta-body">
    <div class="campo-duplo">
      <div class="campo-full" data-field="rotulo">
        {{ subform.rotulo.label_tag }} {{ subform.rotulo }}
        {# holder de erro #}
        <ul class="mini-errors" data-error-holder="rotulo"></ul>
      </div>
      <div class="tipo-col" data-field="tipo">
        {{ subform.tipo.label_tag }} {{ subform.tipo }}
        {# holder de erro #}
        <ul class="mini-errors" data-error-holder="tipo"></ul>
      </div>
    </div>

    <div class="campo-full">
      {{ subform.ajuda.label_tag }} {{ subform.ajuda }}
    </div>

    {# ‚îÄ‚îÄ ORIGEM DAS OP√á√ïES (apenas para Lista) ‚îÄ‚îÄ #}
    <div class="options-origin hide">
      <label style="margin-bottom:.35rem;">Origem das op√ß√µes</label>
      <div class="campo-duplo" style="align-items:center;">
        <div class="campo-full" style="display:flex;gap:1rem;align-items:center;">
          <label class="toggle-label" style="margin:0;gap:.4rem;cursor:pointer;">
            <input type="radio" name="{{ subform.prefix }}-origem_choice" value="manual">
            <span class="toggle-custom"></span>
            <span class="lbl-text">Manual</span>
          </label>

          <label class="toggle-label" style="margin:0;gap:.4rem;cursor:pointer;">
            <input type="radio" name="{{ subform.prefix }}-origem_choice" value="sqlhub">
            <span class="toggle-custom"></span>
            <span class="lbl-text">SQLHub</span>
          </label>
        </div>
        <div class="campo-full"></div>
      </div>
      {{ subform.origem_opcoes }}
      {{ subform.sqlhub_connection_id }}
      {{ subform.sqlhub_query_id }}
      {{ subform.sqlhub_value_field }}
      {{ subform.sqlhub_label_field }}
    </div>

    {# ‚îÄ‚îÄ Op√ß√µes MANUAIS ‚îÄ‚îÄ #}
    <div class="options-block hide">
      <label>Op√ß√µes</label>
      <div class="options-list">
        {% if subform.instance.pk %}
          {% for opc in subform.instance.opcoes.all %}
            <div class="opt-row">
              <input type="text" value="{{ opc.texto }}" class="form-control" placeholder="Texto da op√ß√£o">
              <button type="button" class="opt-del" title="Remover">√ó</button>
            </div>
          {% endfor %}
        {% endif %}
      </div>
      <button type="button" class="btn-add-option">+ Adicionar op√ß√£o</button>
      {{ subform.opcoes_json }}
      {# holder de erro espec√≠fico #}
      <ul class="mini-errors" data-error-holder="opcoes"></ul>
    </div>

    {# ‚îÄ‚îÄ Config SQLHub ‚îÄ‚îÄ #}
    <div class="sqlhub-config hide"
         data-conns-url="{{ url_sqlhub_conns }}"
         data-queries-url="{{ url_sqlhub_queries }}">
      <div class="campo-duplo">
        <div class="campo-full">
          <label>Conex√£o</label>
          <select class="input-select sel-conn">
            <option value="">Carregando‚Ä¶</option>
          </select>
        </div>
        <div class="campo-full">
          <label>Consulta salva</label>
          <select class="input-select sel-query">
            <option value="">Selecione‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="campo-duplo">
        <div class="campo-full">
          <label>Campo (valor)</label>
          <select class="input-select sel-val">
            <option value="">Selecione‚Ä¶</option>
          </select>
        </div>
        <div class="campo-full">
          <label>Campo (r√≥tulo)</label>
          <select class="input-select sel-lbl">
            <option value="">Selecione‚Ä¶</option>
          </select>
        </div>
      </div>

      {# holder de erro espec√≠fico #}
      <ul class="mini-errors" data-error-holder="sqlhub"></ul>
    </div>

    {# ‚îÄ‚îÄ Config de UPLOAD (tipo = arquivo) ‚îÄ‚îÄ #}
    <div class="file-config hide">
      <h4 style="margin:.5rem 0 .25rem">Configura√ß√µes do upload</h4>

      <label class="toggle-label" style="margin:0;gap:.4rem;cursor:pointer;">
        <input type="checkbox" class="cfg-tipos-toggle">
        <span class="toggle-custom"></span>
        <span class="lbl-text">Permitir apenas tipos espec√≠ficos</span>
      </label>

      <div class="cfg-tipos-list hide">
        {% for label in FILE_CAT_LABELS %}
          <label class="cfg-type-item">
            <input type="checkbox" value="{{ label|lower }}">
            <span>{{ label }}</span>
          </label>
        {% endfor %}
      </div>

      <div class="campo-duplo">
        <div class="campo-full">
          <label>M√°ximo de arquivos</label>
          <input type="number" min="1" step="1" value="1" class="input-texto cfg-max-arqs" style="max-width:140px">
        </div>
        <div class="campo-full">
          <label>Tamanho m√°ximo (MB)</label>
          <input type="number" min="1" step="1" value="10" class="input-texto cfg-max-mb" style="max-width:140px">
        </div>
      </div>

      {# holder de erro espec√≠fico #}
      <ul class="mini-errors" data-error-holder="upload"></ul>
    </div>

    {# ‚îÄ‚îÄ Valida√ß√£o de TEXTO/PAR√ÅGRAFO (Somente n√∫meros) ‚îÄ‚îÄ #}
    <div class="text-config hide">
      <h4 style="margin:.5rem 0 .25rem">Valida√ß√£o</h4>
      <label class="toggle-label" style="margin:0;gap:.4rem;cursor:pointer;">
        <input type="checkbox" class="cfg-only-digits">
        <span class="toggle-custom"></span>
        <span class="lbl-text">Aceitar somente n√∫meros</span>
      </label>
    </div>

    {{ subform.valid_json }}
  </div>

  <div class="form-errors">
    {{ subform.non_field_errors }}
    {{ subform.rotulo.errors }} {{ subform.tipo.errors }}
  </div>
</div>
